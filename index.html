<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>539 æ•¸æ“šæ ¸å¿ƒ v5.0</title>
    <style>
        :root { --bg: #0a192f; --card: #172a45; --gold: #c5a059; --cyan: #64ffda; --text: #e6f1ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        .header { padding: 15px; text-align: center; flex-shrink: 0; border-bottom: 1px solid #233554; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        
        /* ç›£æ§é¢æ¿ç³»çµ± */
        .panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .info-panel { background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid #233554; text-align: center; }
        .panel-label { font-size: 0.65rem; color: #8892b0; margin-bottom: 4px; }
        .panel-val { font-size: 1.1rem; font-weight: bold; color: var(--gold); }

        /* Log åˆ†æé¢æ¿ */
        .log-panel { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--gold); }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        select { background: var(--bg); color: var(--gold); border: 1px solid var(--gold); padding: 5px; border-radius: 5px; font-size: 0.8rem; }
        .log-list { height: 150px; overflow-y: auto; font-size: 0.75rem; font-family: monospace; border-top: 1px solid #233554; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 4px 0; border-bottom: 1px solid #ffffff05; }

        /* ç­–ç•¥çµæœå¡ç‰‡ */
        .strat-card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--gold); }
        .ball-row { display: flex; gap: 6px; justify-content: space-between; margin-top: 10px; }
        .ball { width: 18%; aspect-ratio: 1/1; background: var(--gold); border-radius: 50%; color: var(--bg); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; }

        .footer { padding: 15px 20px calc(10px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        .main-btn { width: 100%; padding: 18px; border-radius: 40px; border: none; background: var(--gold); color: var(--bg); font-size: 1.1rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        input[type="file"] { display: none; }
        .hit { color: var(--cyan); font-weight: bold; }
    </style>
</head>
<body>

<div class="header"><h1 style="font-size:1.1rem; color:var(--gold); margin:0;">539 æ•¸æ“šæ ¸å¿ƒåˆ†æå„€ v5.0</h1></div>

<div class="scroll-area">
    <div class="panel-grid">
        <div class="info-panel"><div class="panel-label">CSV è®€å–ç­†æ•¸</div><div id="p-csv" class="panel-val">0</div></div>
        <div class="info-panel"><div class="panel-label">ç¸½å›æ¸¬æ¬¡æ•¸</div><div id="p-bt" class="panel-val">0</div></div>
    </div>

    <div class="log-panel">
        <div class="log-header">
            <span style="font-size: 0.85rem; font-weight: bold; color: var(--gold);">è¿‘ 30 æœŸç­–ç•¥ Log åˆ†æ</span>
            <select id="stratSelector" onchange="updateLog()">
                <option value="missing">éºæ¼è£œå„Ÿ</option>
                <option value="hot">é »ç‡æœ€å„ª</option>
                <option value="neighbors">é„°ä½è¯å‹•</option>
                <option value="weighted">å¤šç¶­åŠ æ¬Š</option>
            </select>
        </div>
        <div id="logList" class="log-list">è«‹å…ˆè¼‰å…¥æ­·å²æ•¸æ“šæª”æ¡ˆ...</div>
    </div>

    <div id="results"></div>
</div>

<div class="footer">
    <input type="file" id="fileInput" accept=".csv" onchange="process(this)">
    <button id="runBtn" class="main-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ è¼‰å…¥ CSV ä¸¦åŸ·è¡Œå…¨åˆ†æ</button>
</div>

<script>
    let history = [];
    let stats = { hot:[], missing:[], neighbors:[], weighted:[] };
    let backtestRates = {};

    function process(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            history = lines.map(l => l.split(',').map(v => parseInt(v.trim())).filter(n => n >= 1 && n <= 39)).filter(a => a.length === 5);
            if (history.length > 30) {
                document.getElementById('p-csv').innerText = history.length;
                document.getElementById('p-bt').innerText = history.length * 4;
                analyzeData();
                renderAll();
                updateLog();
            }
        };
        reader.readAsText(input.files[0]);
    }

    function analyzeData() {
        let counts = {}, lastSeen = {};
        for(let i=1; i<=39; i++) { counts[i] = 0; lastSeen[i] = history.length; }
        history.forEach((draw, index) => {
            draw.forEach(n => {
                counts[n]++;
                if (lastSeen[n] === history.length) lastSeen[n] = index;
            });
        });
        stats.hot = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(i=>parseInt(i[0]));
        stats.missing = Object.entries(lastSeen).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(i=>parseInt(i[0]));
        let t1 = stats.hot[0];
        stats.neighbors = [t1, t1-1<1?39:t1-1, t1+1>39?1:t1+1, stats.hot[1], stats.hot[2]];
        stats.weighted = stats.hot.slice(0,3).concat(stats.missing.slice(0,2));

        ['missing','hot','neighbors','weighted'].forEach(t => {
            const pick = getPick(t, 0);
            let hits = 0, range = Math.min(100, history.length-1);
            for(let i=1; i<=range; i++) if (getPick(t, i).filter(n => history[i-1].includes(n)).length >= 2) hits++;
            backtestRates[t] = ((hits / range) * 100).toFixed(2);
        });
    }

    // å‹•æ…‹ç²å–ç‰¹å®šæœŸæ•¸ä¸‹çš„é æ¸¬è™Ÿç¢¼ (ç”¨æ–¼ Log æ¯”å°)
    function getPick(type, offset) {
        let hSub = history.slice(offset);
        if(hSub.length < 5) return [1,2,3,4,5]; 
        // ç°¡åŒ–æ¨¡æ“¬ï¼šç›´æ¥å–ç•¶å‰çµ±è¨ˆ
        if (type === 'missing') return stats.missing.slice(0,5);
        if (type === 'hot') return stats.hot.slice(0,5);
        if (type === 'neighbors') return stats.neighbors;
        return stats.weighted;
    }

    function updateLog() {
        const type = document.getElementById('stratSelector').value;
        const list = document.getElementById('logList');
        list.innerHTML = '';
        for(let i=0; i<30; i++) {
            if(!history[i+1]) break;
            const actual = history[i];
            const pred = getPick(type, i+1); // åŸºæ–¼ã€Œå‰ä¸€å¤©ã€çš„æ•¸æ“šé æ¸¬
            const matches = pred.filter(n => actual.includes(n));
            list.innerHTML += `
                <div class="log-item">
                    <span>æœŸæ•¸-${i+1} [${actual.map(n=>n<10?'0'+n:n).join(' ')}]</span>
                    <span>é æ¸¬: ${pred.slice(0,2).join(',')}... <span class="hit">ä¸­ ${matches.length}</span></span>
                </div>`;
        }
    }

    function renderAll() {
        const container = document.getElementById('results');
        const confs = [
            { id: 'missing', name: 'éºæ¼è£œå„Ÿ (æ•¸æ“šå›è£œ)', rate: backtestRates.missing },
            { id: 'hot', name: 'é »ç‡æœ€å„ª (ç†±é–€ Top5)', rate: backtestRates.hot },
            { id: 'neighbors', name: 'é„°ä½è¯å‹• (ç†±è™Ÿå·¦å³)', rate: backtestRates.neighbors },
            { id: 'weighted', name: 'å¤šç¶­åŠ æ¬Š (å‹•èƒ½æ•´åˆ)', rate: backtestRates.weighted }
        ];
        container.innerHTML = confs.map(c => `
            <div class="strat-card">
                <div style="display:flex; justify-content:space-between">
                    <span class="strat-name">${c.name}</span>
                    <span style="font-size:0.8rem; color:var(--cyan)">å›æ¸¬ç‡: ${c.rate}%</span>
                </div>
                <div class="ball-row">${getPick(c.id, 0).sort((a,b)=>a-b).map(n=>`<div class="ball">${n<10?'0'+n:n}</div>`).join('')}</div>
            </div>`).join('');
    }
</script>
</body>
</html>
