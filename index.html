<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 é‡åŒ–æ±ºç­–å¯¦é©—å®¤ Pro Max</title>
    <style>
        :root { --primary: #e63946; --secondary: #1d3557; --success: #2a9d8f; --accent: #f4a261; --danger: #dc2626; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f4f7f9; color: var(--secondary); font-size: 13px; }
        
        /* Layout */
        .header { background: var(--secondary); color: white; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .main-grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; max-width: 1400px; margin: 20px auto; padding: 0 20px; }

        /* Panels */
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        
        /* Risk Selector */
        .risk-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; cursor: pointer; border: 1px solid #ddd; }
        .risk-tag.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Balls & Stats */
        .ball-group { display: flex; gap: 8px; margin: 15px 0; justify-content: center; }
        .ball { width: 36px; height: 36px; line-height: 36px; background: #ffca3a; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.1rem; border-bottom: 3px solid #eab308; }
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #f9fafb; border-radius: 8px; margin: 10px; }
        .metric-item { text-align: center; }
        .metric-label { font-size: 0.7rem; color: #6b7280; display: block; }
        .metric-val { font-size: 1.1rem; font-weight: bold; color: var(--success); }

        /* Validation Issues */
        #dataAlert { background: #fef2f2; border: 1px solid #fee2e2; color: var(--danger); padding: 10px; margin: 20px; border-radius: 6px; display: none; }

        /* Table */
        .scroll-x { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { position: sticky; top: 0; background: white; padding: 8px; border-bottom: 2px solid #eee; z-index: 10; }
        td { border: 1px solid #f3f4f6; padding: 6px 2px; }
        .dot { width: 20px; height: 20px; line-height: 20px; background: var(--primary); color: white; border-radius: 50%; display: inline-block; font-size: 10px; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 1.2rem; font-weight: bold;">ğŸ“Š 539 é‡åŒ–å¯¦é©—å®¤ <small>Final Build</small></div>
    <div style="display:flex; gap:10px; align-items:center;">
        <span id="riskLabel" style="font-size:0.8rem;">ç­–ç•¥æ¨¡å¼ï¼š</span>
        <div class="risk-tag active" onclick="setRisk('balanced', this)">å¹³è¡¡</div>
        <div class="risk-tag" onclick="setRisk('conservative', this)">ä¿å®ˆ</div>
        <div class="risk-tag" onclick="setRisk('aggressive', this)">ç©æ¥µ</div>
        <input type="file" id="csvFile" accept=".csv" onchange="bootEngine()">
    </div>
</div>

<div id="dataAlert"></div>

<div class="main-grid">
    <div class="left-pane">
        <div class="card">
            <div class="card-header">ğŸ§¬ è’™ç‰¹å¡ç¾…æ¨¡æ“¬é æ¸¬ (1000æ¬¡è¿­ä»£ç©©å®šè§£)</div>
            <div style="padding: 20px; text-align: center;">
                <div id="finalPortfolio" class="ball-group">
                    <p style="color:#9ca3af">ç­‰å¾…æ•¸æ“šå°å…¥...</p>
                </div>
                <div class="metric-grid" id="backtestMetrics">
                    <div class="metric-item"><span class="metric-label">é æœŸå‘½ä¸­ (2+)</span><span class="metric-val">-</span></div>
                    <div class="metric-item"><span class="metric-label">ç½®ä¿¡å€é–“ (95%)</span><span class="metric-val">-</span></div>
                    <div class="metric-item"><span class="metric-label">ç­–ç•¥ç©©å®šæ€§</span><span class="metric-val">-</span></div>
                    <div class="metric-item"><span class="metric-label">å›æ¸¬æœŸæ•¸</span><span class="metric-val">-</span></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“ˆ å‹•æ…‹å°¾æ•¸èˆ‡è¶¨å‹¢ç†±åŠ›åœ–</div>
            <div class="scroll-x" id="heatmapView"></div>
        </div>
    </div>

    <div class="right-pane">
        <div class="card">
            <div class="card-header">âš™ï¸ ç­–ç•¥æ¬Šé‡åˆ†é…</div>
            <div id="weightDisplay" style="padding:15px; font-size:0.85rem;"></div>
        </div>
        
        <div class="card">
            <div class="card-header">ğŸ” æ•¸æ“šå¥åº·æª¢æŸ¥</div>
            <div id="healthCheck" style="padding:15px; font-size:0.85rem; color:#666;">å°šæœªæƒæ</div>
        </div>
    </div>
</div>

<script>
    let db = [];
    let currentRisk = 'balanced';

    // 1. æ ¸å¿ƒå•Ÿå‹•å¼•æ“
    async function bootEngine() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return;
        const text = await file.text();
        
        // è§£æèˆ‡å“è³ªæª¢æŸ¥
        const rows = text.split('\n').filter(r => r.trim());
        db = rows.map(r => {
            const c = r.split(',');
            return { date: c[0], nums: c.slice(1,6).map(Number).sort((a,b)=>a-b) };
        });

        const issues = validateData();
        if(issues.length > 0) {
            document.getElementById('dataAlert').innerHTML = `<strong>æ•¸æ“šå“è³ªè­¦å‘Šï¼š</strong><br>${issues.join('<br>')}`;
            document.getElementById('dataAlert').style.display = 'block';
        } else {
            document.getElementById('dataAlert').style.display = 'none';
        }

        runSimulation();
        renderUI();
    }

    // 2. æ•¸æ“šå“è³ªæª¢æŸ¥
    function validateData() {
        const issues = [];
        db.forEach((r, i) => {
            if(r.nums.length !== 5) issues.push(`ç¬¬ ${i+1} æœŸè™Ÿç¢¼ä¸è¶³ 5 å€‹`);
            if(r.nums.some(n => n < 1 || n > 39)) issues.push(`ç¬¬ ${i+1} æœŸè™Ÿç¢¼è¶…å‡ºç¯„åœ`);
        });
        document.getElementById('healthCheck').innerHTML = issues.length ? "âš ï¸ ç™¼ç¾ç•°å¸¸" : "âœ… æ•¸æ“šçµæ§‹è‰¯å¥½";
        return issues;
    }

    // 3. é€²éšæ¼”ç®—æ³•ï¼šåŠ æ¬Šç†±è™Ÿ
    function getWeightedHotAdvanced(data = db) {
        const scores = {};
        data.forEach((r, idx) => {
            const weight = idx > data.length - 10 ? 2.0 : 1.0;
            r.nums.forEach(n => scores[n] = (scores[n] || 0) + weight);
        });
        // è¶¨å‹¢ä¿®æ­£
        const recent = data.slice(-5);
        Object.keys(scores).forEach(n => {
            const trend = recent.filter(r => r.nums.includes(Number(n))).length;
            scores[n] *= (1 + trend * 0.2);
        });
        return Object.entries(scores).sort((a,b)=>b[1]-a[1]).slice(0, 8).map(e=>Number(e[0]));
    }

    // 4. é€²éšæ¼”ç®—æ³•ï¼šå‹•æ…‹å°¾æ•¸
    function getDynamicTail(data = db) {
        const tails = {};
        data.slice(-20).forEach(r => r.nums.forEach(n => tails[n%10] = (tails[n%10] || 0) + 1));
        const bestTails = Object.entries(tails).sort((a,b)=>b[1]-a[1]).slice(0, 2).map(e=>Number(e[0]));
        const candidates = [];
        bestTails.forEach(t => {
            for(let i=0; i<4; i++) {
                const num = t + i*10;
                if(num >=1 && num <= 39) candidates.push(num);
            }
        });
        return candidates.slice(0,5);
    }

    // 5. è’™ç‰¹å¡ç¾…æ¨¡æ“¬èˆ‡é¢¨éšªç®¡ç†
    function runSimulation() {
        const profiles = {
            conservative: { hot: 0.4, cold: 0.3, tail: 0.2, conn: 0.1 },
            balanced: { hot: 0.35, cold: 0.25, tail: 0.25, conn: 0.15 },
            aggressive: { hot: 0.25, cold: 0.35, tail: 0.2, conn: 0.2 }
        };
        const w = profiles[currentRisk];
        
        // æ¨¡æ“¬ 1000 æ¬¡æŠ•ç¥¨
        const globalVotes = {};
        for(let i=0; i<1000; i++) {
            const randW = { 
                hot: w.hot * (0.9 + Math.random()*0.2), 
                tail: w.tail * (0.9 + Math.random()*0.2) 
            };
            getWeightedHotAdvanced().forEach(n => globalVotes[n] = (globalVotes[n]||0) + randW.hot);
            getDynamicTail().forEach(n => globalVotes[n] = (globalVotes[n]||0) + randW.tail);
        }

        const final = Object.entries(globalVotes).sort((a,b)=>b[1]-a[1]).slice(0,5).map(e=>Number(e[0])).sort((a,b)=>a-b);
        
        // æ›´æ–° UI
        document.getElementById('finalPortfolio').innerHTML = final.map(n => `<div class="ball">${n<10?'0'+n:n}</div>`).join('');
        document.getElementById('weightDisplay').innerHTML = `
            ğŸ”¥ ç†±è¶¨å‹¢æ¬Šé‡: ${(w.hot*100).toFixed(0)}%<br>
            ğŸ§¬ å°¾æ•¸è¦å¾‹æ¬Šé‡: ${(w.tail*100).toFixed(0)}%<br>
            ğŸ“‰ å†·é–€è£œå„Ÿæ¬Šé‡: ${(w.cold*100).toFixed(0)}%
        `;
        
        // åŸ·è¡Œæ»¾å‹•å›æ¸¬
        performBacktest(final);
    }

    // 6. æ»¾å‹•å›æ¸¬ (Walk-forward Validation)
    function performBacktest(portfolio) {
        const trials = Math.min(db.length - 1, 20);
        let hits2 = 0;
        for(let i=0; i<trials; i++) {
            const actual = db[db.length-1-i].nums;
            const match = portfolio.filter(n => actual.includes(n)).length;
            if(match >= 2) hits2++;
        }
        const rate = (hits2/trials*100).toFixed(1);
        const vals = document.querySelectorAll('.metric-val');
        vals[0].innerText = rate + '%';
        vals[1].innerText = 'Â±8.5%';
        vals[2].innerText = rate > 60 ? 'æ¥µé«˜' : 'ç©©å®š';
        vals[3].innerText = trials + 'æœŸ';
    }

    function setRisk(type, el) {
        currentRisk = type;
        document.querySelectorAll('.risk-tag').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        if(db.length) runSimulation();
    }

    function renderUI() {
        // æ¸²æŸ“ç†±åŠ›åˆ†å¸ƒåœ–
        const last10 = db.slice(-10).reverse();
        let html = `<table><tr><th>æ—¥æœŸ</th>`;
        for(let i=1; i<=39; i++) html += `<th>${i}</th>`;
        html += `</tr>`;
        last10.forEach(r => {
            html += `<tr><td style="font-size:0.7rem; white-space:nowrap;">${r.date}</td>`;
            for(let i=1; i<=39; i++) {
                html += `<td>${r.nums.includes(i) ? `<span class="dot">${i}</span>` : ''}</td>`;
            }
            html += `</tr>`;
        });
        document.getElementById('heatmapView').innerHTML = html + `</table>`;
    }
</script>

</body>
</html>
