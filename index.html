<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539策略回測 Demo v7</title>
<style>
html, body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#0B2545; color:#F0F0F0; }
.container { display:flex; flex-direction:column; align-items:center; padding:10px; min-height:100vh; box-sizing:border-box; }
h1 { font-size:1.8em; margin:10px 0; text-align:center; }
.card { background:#142850; border-radius:12px; padding:15px; margin:10px 0; width:90%; max-width:500px; box-shadow:0 4px 8px rgba(0,0,0,0.3); }
.card h2 { margin:0 0 10px 0; font-size:1.2em; color:#F8F8FF; }
.card p { margin:5px 0; font-size:1em; line-height:1.4; }
button, select { background:#1B3B6F; color:#F0F0F0; border:none; border-radius:10px; padding:10px; margin:5px 0; font-size:1em; width:100%; max-width:500px; }
button:active, select:active { background:#1F4B99; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #334A69; padding:8px; text-align:center; }
th { background:#1B3B6F; }
td { background:#142850; }
@media(max-width:400px){ h1{font-size:1.5em;} .card{padding:12px;} button, select{padding:8px;font-size:0.9em;} }
</style>
</head>
<body>
<div class="container">
<h1>539策略回測 Demo v7</h1>

<div class="card">
<h2>上傳歷史 CSV</h2>
<input type="file" id="csvFile" accept=".csv">
<p id="csvCount">CSV 筆數：0</p>
</div>

<div class="card">
<h2>策略模組</h2>
<p>L1：S1 趨勢動能</p>
<p>L2：S1 + S2 冷熱混合</p>
<p>L3：S1 + S2 + S3 結構約束</p>
</div>

<div class="card">
<h2>回測控制</h2>
<button onclick="runBacktest()">執行回測</button>
<p id="backtestCount">回測筆數：0</p>
</div>

<div class="card">
<h2>回測 Log (最近30期，最新在上)</h2>
<label for="strategySelect">選擇策略：</label>
<select id="strategySelect" onchange="updateLog()">
  <option value="L1">L1</option>
  <option value="L2">L2</option>
  <option value="L3">L3</option>
</select>
<table>
<thead>
<tr>
<th>日期</th><th>開獎號碼</th><th>預測號碼</th><th>命中數量</th><th>近5期命中率</th>
</tr>
</thead>
<tbody id="backtestLog"></tbody>
</table>
</div>
</div>

<script>
let csvData = [];
let backtestResults = [];

document.getElementById('csvFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    const text = event.target.result;
    csvData = text.trim().split('\n').slice(1).map(line=>{
      const [date,n1,n2,n3,n4,n5] = line.split(',');
      return {date, numbers:[n1,n2,n3,n4,n5]};
    });
    document.getElementById('csvCount').innerText = `CSV 筆數：${csvData.length}`;
  };
  reader.readAsText(file);
});

// 計算號碼出現頻率
function computeFrequency(data){
  const freq = Array(40).fill(0);
  data.forEach(row=>{
    row.numbers.forEach(n => freq[parseInt(n)]++);
  });
  return freq;
}

// L1: 前5高頻號碼
function generatePredictionL1(freq){
  const nums = [];
  freq.forEach((count, n) => { if(n>0) nums.push({n, count}); });
  nums.sort((a,b)=>b.count - a.count);
  return nums.slice(0,5).map(x=>x.n);
}

// L2: 冷熱混合 3高頻+2低頻
function generatePredictionL2(freq){
  const nums = [];
  let sorted = freq.map((c,n)=>({n,c})).filter(x=>x.n>0).sort((a,b)=>b.c - a.c);
  nums.push(...sorted.slice(0,3).map(x=>x.n));
  let low = sorted.slice(-10).map(x=>x.n).filter(n=>!nums.includes(n));
  nums.push(...low.slice(0,2));
  return nums;
}

// L3: 結構約束 依區間固定
function generatePredictionL3(freq){
  const nums = [];
  let sorted = freq.map((c,n)=>({n,c})).filter(x=>x.n>0).sort((a,b)=>b.c - a.c);
  const ranges = [[1,13],[14,26],[27,39]];
  ranges.forEach(r=>{
    const arr = sorted.filter(x=>x.n>=r[0] && x.n<=r[1]).map(x=>x.n).slice(0,2);
    arr.forEach(n=>{ if(nums.length<5) nums.push(n); });
  });
  return nums;
}

function hitCount(actual, pred){
  return pred.filter(n => actual.includes(n.toString())).length;
}

function runBacktest(){
  backtestResults = [];
  const freq = computeFrequency(csvData);
  csvData.forEach(row=>{
    const l1 = generatePredictionL1(freq);
    const l2 = generatePredictionL2(freq);
    const l3 = generatePredictionL3(freq);
    backtestResults.push({date:row.date, actual:row.numbers, strategy:'L1', pred:l1, hits:hitCount(row.numbers,l1)});
    backtestResults.push({date:row.date, actual:row.numbers, strategy:'L2', pred:l2, hits:hitCount(row.numbers,l2)});
    backtestResults.push({date:row.date, actual:row.numbers, strategy:'L3', pred:l3, hits:hitCount(row.numbers,l3)});
  });
  document.getElementById('backtestCount').innerText = `回測筆數：${backtestResults.length}`;
  updateLog();
}

function updateLog(){
  const select = document.getElementById('strategySelect').value;
  const logBody = document.getElementById('backtestLog');
  logBody.innerHTML = '';
  // 取最近30期，越新越上
  const filtered = backtestResults.filter(r=>r.strategy===select).slice(-30).reverse();
  
  filtered.forEach((r, idx)=>{
    // 計算近5期命中率
    const recent5 = backtestResults.filter(x=>x.strategy===select).slice(-5);
    const hitsSum = recent5.reduce((sum,x)=>sum+x.hits,0);
    const rate = (hitsSum / (recent5.length*2)*100).toFixed(1) + '%'; // 2星滿分
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.actual.join(',')}</td><td>${r.pred.join(',')}</td><td>${r.hits}</td><td>${rate}</td>`;
    logBody.appendChild(tr);
  });
}
</script>
</body>
</html>
