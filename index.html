<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539 QUANT PRO</title>

<style>
body{
    background:#0f172a;
    color:#f1f5f9;
    font-family:"Microsoft JhengHei",sans-serif;
    padding:20px;
}
.card{
    background:#1e293b;
    padding:20px;
    border-radius:16px;
    margin-bottom:20px;
}
.ball{
    display:inline-block;
    width:38px;
    height:38px;
    line-height:38px;
    border-radius:50%;
    background:#334155;
    color:#38bdf8;
    margin:4px;
    font-weight:bold;
    text-align:center;
}
.recommend .ball{
    background:#38bdf8;
    color:#0f172a;
}
button{
    width:100%;
    padding:14px;
    background:#38bdf8;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}
</style>
</head>

<body>

<div class="card">
    <h2>539 CSV 載入</h2>
    <input type="file" id="csvFile" accept=".csv">
    <br><br>
    <button onclick="runAll()">啟動分析</button>
</div>

<div id="history" class="card"></div>
<div id="result" class="card"></div>

<script>
let HIST_DATA = [];
let CORR_MATRIX = {};

async function runAll(){
    const file = document.getElementById("csvFile").files[0];
    if(!file){ alert("請選 CSV"); return; }

    const text = await file.text();
    HIST_DATA = parseCSV(text);

    if(!HIST_DATA.length){
        alert("CSV 格式錯誤");
        return;
    }

    buildCorrelationMatrix(HIST_DATA);
    showHistory();
    generateRecommendation();
}

function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    lines.shift();
    return lines.map(l=>{
        const p=l.split(",");
        if(p.length!==6) return null;
        const nums=p.slice(1,6).map(n=>+n).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
        if(nums.length!==5) return null;
        return {date:p[0],nums};
    }).filter(Boolean).sort((a,b)=>new Date(a.date)-new Date(b.date));
}

function buildCorrelationMatrix(data){
    CORR_MATRIX={};
    for(let i=0;i<data.length-1;i++){
        data[i].nums.forEach(c=>{
            CORR_MATRIX[c]=CORR_MATRIX[c]||{};
            data[i+1].nums.forEach(n=>{
                CORR_MATRIX[c][n]=(CORR_MATRIX[c][n]||0)+1;
            });
        });
    }
}

function showHistory(){
    const last = HIST_DATA.slice(-5).reverse();
    document.getElementById("history").innerHTML = `
        <h3>近期開獎</h3>
        ${last.map(d=>`
            <div>
                <small>${d.date}</small><br>
                ${d.nums.map(n=>`<span class="ball">${String(n).padStart(2,"0")}</span>`).join("")}
            </div>
        `).join("")}
    `;
}

function generateRecommendation(){
    const lastNums = HIST_DATA[HIST_DATA.length-1].nums;
    let score={};

    lastNums.forEach(c=>{
        const rel=CORR_MATRIX[c]||{};
        Object.keys(rel).forEach(n=>{
            if(lastNums.includes(+n)) return;
            score[n]=(score[n]||0)+rel[n];
        });
    });

    const picks = Object.entries(score)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5)
        .map(e=>+e[0])
        .sort((a,b)=>a-b);

    document.getElementById("result").innerHTML = `
        <h3>量化推薦選號</h3>
        <div class="recommend">
            ${picks.map(n=>`<span class="ball">${String(n).padStart(2,"0")}</span>`).join("")}
        </div>
    `;
}
</script>

</body>
</html>
