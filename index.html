<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 智慧預測系統</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 20px; color: var(--primary); }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .full-width { grid-column: span 2; }
        h3 { border-left: 4px solid var(--accent); padding-left: 10px; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #eee; }
        .hit { color: white; background: var(--accent); border-radius: 50%; display: inline-block; width: 20px; height: 20px; }
        #chartCanvas { background: #fff; width: 100%; height: 300px; border: 1px solid #ccc; }
        .prediction-box { font-size: 24px; font-weight: bold; color: #2980b9; letter-spacing: 5px; }
        #logConsole { background: #333; color: #27ae60; padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h3>Panel 1: 資料上傳 (CSV)</h3>
        <input type="file" id="csvFile" accept=".csv">
        <p><small>格式：日期, 號1, 號2, 號3, 號4, 號5</small></p>
    </div>

    <div class="panel">
        <h3>Panel 3: 下期預測 (8碼)</h3>
        <div id="nextPrediction" class="prediction-box">等待資料...</div>
    </div>

    <div class="panel full-width">
        <h3>Panel 2: 近 10 期命中分析</h3>
        <div id="historyTable">上傳後顯示...</div>
    </div>

    <div class="panel full-width">
        <h3>Panel 4: 號碼連號分佈圖 (走勢)</h3>
        <canvas id="chartCanvas"></canvas>
    </div>

    <div class="panel full-width">
        <h3>Panel 5: 系統 Log</h3>
        <div id="logConsole">系統就緒...</div>
    </div>
</div>

<script>
    let rawData = [];
    const logBox = document.getElementById('logConsole');

    function addLog(msg) {
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML += `[${time}] ${msg}<br>`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(f) {
            const lines = f.target.result.split('\n');
            rawData = lines.map(line => line.split(',').map(s => s.trim())).filter(l => l.length >= 6);
            addLog(`成功讀取 ${rawData.length} 筆資料`);
            processSystem();
        };
        reader.readAsText(file);
    });

    function processSystem() {
        const history = [];
        // 取出數值部分
        const data = rawData.map(row => ({
            date: row[0],
            nums: row.slice(1, 6).map(Number).sort((a,b)=>a-b)
        }));

        // 模擬預測邏輯 (權重演算法：基於過去 30 期頻率)
        for(let i=0; i<Math.min(10, data.length-1); i++) {
            const trainingData = data.slice(i+1, i+31); 
            const pred = generatePrediction(trainingData);
            const actual = data[i].nums;
            const hits = actual.filter(n => pred.includes(n));
            history.push({ date: data[i].date, actual, pred, hitCount: hits.length });
        }

        renderHistory(history);
        renderNext(data.slice(0, 30));
        drawChart(data.slice(0, 20));
    }

    function generatePrediction(pastData) {
        // 簡易權重：統計頻率 + 隨機補償
        const freq = {};
        pastData.forEach(d => d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1));
        const sorted = Object.keys(freq).sort((a,b) => freq[b] - freq[a]);
        // 取熱門 5 碼 + 冷門 3 碼平衡
        let res = sorted.slice(0, 5).map(Number);
        while(res.length < 8) {
            let r = Math.floor(Math.random() * 39) + 1;
            if(!res.includes(r)) res.push(r);
        }
        return res.sort((a,b)=>a-b);
    }

    function renderHistory(history) {
        let html = `<table><tr><th>日期</th><th>開獎號</th><th>預測 8 碼</th><th>命中數</th></tr>`;
        history.forEach(h => {
            const hitStars = '★'.repeat(h.hitCount) + '☆'.repeat(Math.max(0, 3-h.hitCount));
            html += `<tr><td>${h.date}</td><td>${h.actual.join(', ')}</td><td>${h.pred.join(', ')}</td>
                     <td><span class="${h.hitCount>=3?'hit':''}">${h.hitCount}</span> ${hitStars}</td></tr>`;
        });
        document.getElementById('historyTable').innerHTML = html + `</table>`;
    }

    function renderNext(pastData) {
        const next = generatePrediction(pastData);
        document.getElementById('nextPrediction').innerText = next.join(' - ');
        addLog(`下期預測計算完成：${next}`);
    }

    function drawChart(data) {
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0, canvas.width, canvas.height);
        
        const cellW = canvas.width / 40;
        const cellH = canvas.height / (data.length + 1);

        // 畫坐標軸
        ctx.font = "10px Arial";
        for(let i=1; i<=39; i++) {
            ctx.fillText(i, i * cellW, 15);
        }

        // 畫分布點
        data.forEach((row, rowIndex) => {
            const y = (rowIndex + 1) * cellH + 15;
            ctx.fillText(row.date.slice(-5), 2, y);
            row.nums.forEach(n => {
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(n * cellW + 5, y - 3, 4, 0, Math.PI*2);
                ctx.fill();
            });
        });
        addLog("連號分佈圖更新完畢");
    }
</script>

</body>
</html>
