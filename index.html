<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 ç­–ç•¥å›æ¸¬èˆ‡é æ¸¬</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 10px; }
td, th { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
.hit2 { background: #d0f0d0; }
.hit3 { background: #90e090; font-weight: bold; }
.warn { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>539 å›æ¸¬ / ç­–ç•¥æ¨¡æ“¬ç³»çµ±</h2>
<input type="file" id="csvFile" accept=".csv">
<button onclick="run()">åŸ·è¡Œå›æ¸¬</button>

<div id="summary"></div>
<div id="warn"></div>
<div id="next"></div>
<div id="log"></div>

<script>
function parseCSV(text) {
  return text.trim().split('\n').slice(1).map(l => {
    const p = l.split(',');
    return { date: p[0], nums: p.slice(1).map(Number) };
  });
}

function run() {
  const f = document.getElementById('csvFile').files[0];
  if (!f) return alert('è«‹ä¸Šå‚³ CSV');

  const r = new FileReader();
  r.onload = e => simulate(parseCSV(e.target.result));
  r.readAsText(f);
}

function simulate(data) {
  let hit2 = 0, hit3 = 0, hit4 = 0;
  let no3 = 0;
  let rows = '';

  for (let i = 10; i < data.length; i++) {
    const hist = data.slice(i - 10, i);
    const target = data[i].nums;

    const freq = {};
    hist.forEach(d => d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1));

    const hot = Object.keys(freq).filter(n => freq[n] >= 2).map(Number);
    const lastSeen = {};
    data.slice(0, i).forEach((d, idx) => d.nums.forEach(n => lastSeen[n] = idx));
    const gap = Object.keys(lastSeen).filter(n => i - lastSeen[n] >= 10).map(Number);

    const pool = [...new Set([...hot, ...gap])].filter(n => n >= 1 && n <= 39);

    let picks = [];
    while (picks.length < 10 && pool.length >= 5) {
      let c = [];
      while (c.length < 5) {
        const n = pool[Math.floor(Math.random() * pool.length)];
        if (!c.includes(n)) c.push(n);
      }
      const odd = c.filter(n => n % 2).length;
      const sum = c.reduce((a, b) => a + b, 0);
      if ((odd === 2 || odd === 3) && sum >= 70 && sum <= 115) {
        picks.push(c.sort((a,b)=>a-b));
      }
    }

    let best = 0;
    picks.forEach(p => {
      const h = p.filter(n => target.includes(n)).length;
      best = Math.max(best, h);
    });

    if (best >= 2) hit2++;
    if (best >= 3) hit3++;
    if (best >= 4) hit4++;
    if (best < 3) no3++; else no3 = 0;

    rows += `<tr class="${best>=3?'hit3':best>=2?'hit2':''}">
      <td>${data[i].date}</td>
      <td>${best}</td>
      <td>${picks.map(p=>'['+p.join(' ')+']').join('<br>')}</td>
    </tr>`;
  }

  document.getElementById('summary').innerHTML = `
  <h3>å›æ¸¬çµæœ</h3>
  å¯å›æ¸¬æœŸæ•¸ï¼š${data.length - 10}<br>
  å‡ºæ‰‹æœŸæ•¸ï¼š${data.length - 10}<br>
  â‰¥2ï¼š${(hit2/(data.length-10)*100).toFixed(1)}%<br>
  â‰¥3ï¼š${(hit3/(data.length-10)*100).toFixed(1)}%<br>
  â‰¥4ï¼š${(hit4/(data.length-10)*100).toFixed(1)}%
  `;

  document.getElementById('warn').innerHTML =
    no3 >= 20 ? `<div class="warn">âš  å·²é€£çºŒ ${no3} æœŸæœªå‡º â‰¥3ï¼Œå»ºè­°åœæ‰‹</div>` : '';

  document.getElementById('log').innerHTML =
    `<table><tr><th>æ—¥æœŸ</th><th>å‘½ä¸­</th><th>å‡ºæ‰‹çµ„åˆ</th></tr>${rows}</table>`;

  predictNext(data);
}

function predictNext(data) {
  const hist = data.slice(-10);
  const freq = {};
  hist.forEach(d => d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1));
  const hot = Object.keys(freq).filter(n => freq[n] >= 2).map(Number);

  const pool = hot.sort(() => 0.5 - Math.random()).slice(0, 10);
  let result = [];
  while (result.length < 10 && pool.length >= 5) {
    let c = [];
    while (c.length < 5) {
      const n = pool[Math.floor(Math.random() * pool.length)];
      if (!c.includes(n)) c.push(n);
    }
    const odd = c.filter(n => n % 2).length;
    const sum = c.reduce((a,b)=>a+b,0);
    if ((odd === 2 || odd === 3) && sum >= 70 && sum <= 115)
      result.push(c.sort((a,b)=>a-b));
  }

  document.getElementById('next').innerHTML = `
  <h3>ğŸ“Œ 1/14 æ¨¡æ“¬é æ¸¬ï¼ˆ10 çµ„ï¼‰</h3>
  ${result.map(p=>'['+p.join(' ')+']').join('<br>')}
  `;
}
</script>
</body>
</html>
