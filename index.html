<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>539 智能分析系統 - iOS 優化版</title>
<style>
:root {
    --primary-color: #1a3a5f;
    --accent-color: #3e95cd;
    --success-color: #28a745;
    --bg-color: #f0f2f5;
    --card-bg: #ffffff;
}
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'PingFang TC', sans-serif; 
    background: var(--bg-color); margin:0; padding:15px; color:#333; line-height:1.6;
    -webkit-font-smoothing: antialiased;
}
.container { max-width:1200px; margin:0 auto; }
header { text-align:center; margin-bottom:20px; padding:15px; background: var(--primary-color); color:white; border-radius:12px; }
header h1 { font-size: 1.4rem; margin: 0; }
header p { font-size: 0.9rem; margin: 5px 0 0; opacity: 0.8; }

.upload-section { background: var(--card-bg); padding:20px; border-radius:12px; text-align:center; margin-bottom:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
input[type=file], input[type=number] { font-size: 16px; margin: 10px 0; }

button { background:var(--accent-color); color:white; border:none; padding:12px 20px; border-radius:8px; font-weight:bold; cursor:pointer; transition:0.2s; margin:5px; -webkit-appearance: none; }
button:active { transform: scale(0.98); opacity: 0.9; }

.dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }
@media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }

.card { background:var(--card-bg); padding:15px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
table { width:100%; border-collapse:collapse; margin-top:10px; font-size: 0.9rem; }
th, td { padding:8px; border-bottom:1px solid #eee; text-align:center; }

.ball { display:inline-block; width:28px; height:28px; line-height:28px; text-align:center; border-radius:50%; background:#e9ecef; margin:2px; font-weight:bold; font-size:13px; }
.high-rate .ball { background: var(--success-color); color:white; }

.strategy-block { border-left:4px solid var(--accent-color); padding-left:10px; margin:15px 0; background:#fcfcfc; }
.rate-badge { font-size:11px; padding:2px 6px; border-radius:10px; background:#eee; margin-left:2px; white-space: nowrap; }

.chart-container { position: relative; height: 300px; width: 100%; background:white; padding:15px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-top:15px; }
.inline-input { width: 45px; height: 40px; text-align:center; margin:0 2px; border: 1px solid #ccc; border-radius: 6px; -webkit-appearance: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <header>
        <h1>539 智能分析系統</h1>
        <p>機率評估模型 (iOS 優化版)</p>
    </header>

    <div class="upload-section">
        <strong>Step 1: 匯入數據 (CSV)</strong><br>
        <input type="file" id="csvFile" accept=".csv"><br>
        <button onclick="runAll()">開始回測分析</button>
    </div>

    <div class="dashboard-grid">
        <div id="history" class="card"><h3>最近 5 期歷史</h3><p style="color:gray">等待載入...</p></div>
        <div id="stats_table" class="card"><h3>策略歷史表現</h3><p style="color:gray">等待載入...</p></div>
    </div>

    <div id="results" class="card">
        <h3>智能建議組合</h3>
        <p style="color:gray">載入數據後自動產生建議...</p>
    </div>

    <div class="card" style="margin-top:15px;">
        <h3>策略 D - 自選驗證</h3>
        <div style="display: flex; justify-content: center; margin-bottom: 10px;">
            <input type="number" class="inline-input" id="userNum1">
            <input type="number" class="inline-input" id="userNum2">
            <input type="number" class="inline-input" id="userNum3">
            <input type="number" class="inline-input" id="userNum4">
            <input type="number" class="inline-input" id="userNum5">
        </div>
        <button onclick="verifyUserPick()" style="width: 100%;">驗證自選命中率</button>
        <div id="userPickResult" style="margin-top:10px; font-size:14px;"></div>
    </div>

    <div class="chart-container">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<script>
const RULES = [
    { name: "A_保守型", pool: "last1+5", desc:"追蹤熱碼位移。" },
    { name: "B_均衡型", pool: "last5+5+10", desc:"平衡冷熱號碼。" },
    { name: "C_進取型", pool: "last5+10", desc:"積極跳號策略。" }
];

let HIST_DATA = [];

async function runAll(){
    const fileInput=document.getElementById("csvFile");
    if(!fileInput.files[0]){ alert("請先選取 CSV 檔案"); return; }
    const text=await fileInput.files[0].text();
    HIST_DATA=parseCSV(text);
    showHistory(HIST_DATA);
    const stats=doBacktest(HIST_DATA);
    renderStatsTable(stats);
    drawTrendChart(stats.map(s=>s.hit2Rate*100), stats.map(s=>s.hit3Rate*100));
    renderTopCombinations(HIST_DATA, stats);
    renderNextPeriod(HIST_DATA);
}

function parseCSV(text){
    const lines=text.trim().split("\n");
    lines.shift();
    return lines.map(l=>{
        const p=l.split(",");
        return {date:p[0], nums:p.slice(2,7).map(n=>parseInt(n))};
    }).sort((a,b)=>new Date(a.date)-new Date(b.date));
}

function showHistory(data){
    let html="<h3>最近 5 期開獎</h3><table><tr><th>日期</th><th>號碼</th></tr>";
    data.slice(-5).reverse().forEach(d=>{
        html+=`<tr><td>${d.date.slice(5)}</td><td>${d.nums.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</td></tr>`;
    });
    html+="</table>";
    document.getElementById("history").innerHTML=html;
}

function doBacktest(data){
    const stats=RULES.map(r=>({rule:r, hit5:0, hit4:0, hit3:0, hit2:0, total:0}));
    for(let i=5;i<data.length;i++){
        const prev=data.slice(i-5,i), actual=data[i].nums;
        stats.forEach(s=>{
            const pick=generatePick(prev,s.rule);
            const hit=countHit(actual,pick);
            s.total++; if(hit>=2)s.hit2++; if(hit>=3)s.hit3++; if(hit>=4)s.hit4++; if(hit==5)s.hit5++;
        });
    }
    stats.forEach(s=>{ 
        s.hit2Rate=s.hit2/s.total; 
        s.hit3Rate=s.hit3/s.total;
        s.hit4Rate=s.hit4/s.total;
        s.hit5Rate=s.hit5/s.total;
    });
    return stats;
}

function renderStatsTable(stats){
    let html="<h3>策略歷史表現</h3><table><tr><th>策略</th><th>中3</th><th>中2</th></tr>";
    stats.forEach(s=>{
        html+=`<tr><td><strong>${s.rule.name}</strong></td><td>${(s.hit3Rate*100).toFixed(1)}%</td><td>${(s.hit2Rate*100).toFixed(1)}%</td></tr>`;
    });
    html+="</table>";
    document.getElementById("stats_table").innerHTML=html;
}

function drawTrendChart(hit2Data, hit3Data){
    const ctx=document.getElementById("trendChart").getContext("2d");
    if(window.myChart)window.myChart.destroy();
    window.myChart=new Chart(ctx,{
        type:'bar',
        data:{ 
            labels:RULES.map(r=>r.name), 
            datasets:[
                { label:'中2+ (%)', data: hit2Data, backgroundColor:'#3e95cd' },
                { label:'中3+ (%)', data: hit3Data, backgroundColor:'#1a3a5f' }
            ]
        },
        options:{ 
            maintainAspectRatio: false,
            responsive:true, 
            scales:{ y:{ beginAtZero:true, max:100 } }
        }
    });
}

function countHit(actual,pick){ return actual.filter(n=>pick.includes(n)).length; }

function estimateHitRate(pick,data,minHit){
    let count=0; data.forEach(d=>{ if(countHit(d.nums,pick)>=minHit) count++; });
    return count/data.length;
}

function buildPool(latest5,rule){
    const pool=new Set();
    if(rule.pool.includes("last1")) latest5[4].nums.forEach(n=>pool.add(n));
    if(rule.pool.includes("last5")) latest5.forEach(d=>d.nums.forEach(n=>pool.add(n)));
    [...pool].forEach(n=>{
        if(rule.pool.includes("+5") && n+5<=39) pool.add(n+5);
        if(rule.pool.includes("+10") && n+10<=39) pool.add(n+10);
    });
    return [...pool];
}

function generatePick(prev,rule){
    const pool=buildPool(prev,rule);
    return shuffle(pool).slice(0,5).sort((a,b)=>a-b);
}

function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

function renderTopCombinations(data, stats){
    const resultsDiv=document.getElementById("results");
    resultsDiv.innerHTML="<h3>智能建議組合</h3>";

    stats.forEach(s=>{
        const pool=buildPool(data.slice(-5), s.rule);
        const candidates=[];
        for(let i=0;i<50;i++){
            const pick=shuffle(pool).slice(0,5).sort((a,b)=>a-b);
            const h2=estimateHitRate(pick,data,2);
            const h3=estimateHitRate(pick,data,3);
            const h4=estimateHitRate(pick,data,4);
            const h5=estimateHitRate(pick,data,5);
            const expected=(h2*0.3 + h3*0.5 + h4*1 + h5*5);
            candidates.push({pick,h2,h3,h4,h5,expected});
        }
        candidates.sort((a,b)=>b.expected-a.expected);
        const best=candidates[0];
        const sBlock=document.createElement("div");
        sBlock.className="strategy-block high-rate";
        sBlock.innerHTML=`<strong>${s.rule.name}</strong><br>` + 
            best.pick.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("") +
            `<br><span class="rate-badge">期望值: ${(best.expected*100).toFixed(1)}%</span>`;
        resultsDiv.appendChild(sBlock);
    });
}

function verifyUserPick(){
    if(HIST_DATA.length==0){ alert("請先載入 CSV"); return; }
    const pick=[];
    for(let i=1;i<=5;i++){
        const v=parseInt(document.getElementById("userNum"+i).value);
        if(!isNaN(v) && v>=1 && v<=39) pick.push(v);
    }
    if(pick.length!=5){ alert("請輸入 5 個號碼"); return; }
    const h2=estimateHitRate(pick,HIST_DATA,2);
    const h3=estimateHitRate(pick,HIST_DATA,3);
    const h4=estimateHitRate(pick,HIST_DATA,4);
    const h5=estimateHitRate(pick,HIST_DATA,5);
    document.getElementById("userPickResult").innerHTML=
        `中2+命中: ${(h2*100).toFixed(1)}%<br>`+
        `中3+命中: ${(h3*100).toFixed(1)}%<br>`+
        `中4+命中: ${(h4*100).toFixed(1)}%<br>`+
        `中5命中: ${(h5*100).toFixed(1)}%`;
}

// 熱碼權重生成下期推薦組合
function renderNextPeriod(data){
    const resultsDiv=document.getElementById("results");
    const nextDiv=document.createElement("div");
    nextDiv.className="strategy-block";
    nextDiv.innerHTML="<strong>近期趨勢推薦</strong><br>";

    const freq={};
    data.forEach(d=>d.nums.forEach(n=>{ freq[n]=(freq[n]||0)+1; }));
    const weightedPool=[];
    for(const n in freq){
        for(let i=0;i<freq[n];i++) weightedPool.push(parseInt(n));
    }
    const pick=[];
    while(pick.length<5){
        const choice=weightedPool[Math.floor(Math.random()*weightedPool.length)];
        if(!pick.includes(choice)) pick.push(choice);
    }
    pick.sort((a,b)=>a-b);
    nextDiv.innerHTML+=pick.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("");
    resultsDiv.appendChild(nextDiv);
}
</script>
</body>
</html>
