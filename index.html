<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539策略回測 Demo v12</title>
<style>
html, body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#0B2545; color:#F0F0F0; }
.container { display:flex; flex-direction:column; align-items:center; padding:10px; min-height:100vh; box-sizing:border-box; }
h1 { font-size:1.8em; margin:10px 0; text-align:center; }
.card { background:#142850; border-radius:12px; padding:15px; margin:10px 0; width:90%; max-width:500px; box-shadow:0 4px 8px rgba(0,0,0,0.3); }
.card h2 { margin:0 0 10px 0; font-size:1.2em; color:#F8F8FF; }
.card p { margin:5px 0; font-size:1em; line-height:1.4; }
button, select { background:#1B3B6F; color:#F0F0F0; border:none; border-radius:10px; padding:10px; margin:5px 5px 5px 0; font-size:1em; width:48%; box-sizing:border-box; }
span.rateDisplay { display:inline-block; width:48%; text-align:center; font-weight:bold; font-size:1em; color:#FFD700; line-height:2.2em; vertical-align:middle; }
#nextPrediction { margin-top:8px; font-size:1.1em; font-weight:bold; color:#00FFCC; }
.table-container { width:100%; overflow-x:auto; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #334A69; padding:8px; text-align:center; }
th { background:#1B3B6F; }
td { background:#142850; }
@media(max-width:400px){ h1{font-size:1.5em;} .card{padding:12px;} button, select{padding:8px;font-size:0.9em;} }
</style>
</head>
<body>
<div class="container">
<h1>539策略回測 Demo v12</h1>

<div class="card">
<h2>上傳歷史 CSV</h2>
<input type="file" id="csvFile" accept=".csv">
<p id="csvCount">CSV 筆數：0</p>
</div>

<div class="card">
<h2>策略模組</h2>
<p>L1：高頻 + 區間平衡 + 避免重複上期（強化）</p>
<p>L2_new2：冷熱號碼 + 近期熱門 + 區間平衡（替換原 L2）</p>
<p>L3：區間選號 + 最近熱門號碼（強化）</p>
</div>

<div class="card">
<h2>回測控制</h2>
<button onclick="runBacktest()">執行回測</button>
<p id="backtestCount">回測筆數：0</p>
</div>

<div class="card">
<h2>下期預測號碼</h2>
<select id="strategySelectPrediction" onchange="updateNextPrediction()">
  <option value="L1">L1</option>
  <option value="L2_new2">L2_new2</option>
  <option value="L3">L3</option>
</select>
<p id="nextPrediction">預測號碼: --</p>
</div>

<div class="card">
<h2>回測 Log (最近30期，最新在上)</h2>
<div style="display:flex; align-items:center; margin-bottom:5px;">
<select id="strategySelect" onchange="updateLog()">
  <option value="L1">L1</option>
  <option value="L2_new2">L2_new2</option>
  <option value="L3">L3</option>
</select>
<span class="rateDisplay" id="recent5Rate">近5期命中率: --</span>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>日期</th><th>開獎號碼</th><th>預測號碼</th><th>命中數量</th>
</tr>
</thead>
<tbody id="backtestLog"></tbody>
</table>
</div>
</div>
</div>

<script>
let csvData = [];
let backtestResults = [];

// CSV 上傳
document.getElementById('csvFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    const text = event.target.result;
    csvData = text.trim().split('\n').slice(1).map(line=>{
      const [date,n1,n2,n3,n4,n5] = line.split(',');
      return {date, numbers:[n1,n2,n3,n4,n5]};
    });
    document.getElementById('csvCount').innerText = `CSV 筆數：${csvData.length}`;
    updateNextPrediction();
  };
  reader.readAsText(file);
});

// 計算號碼頻率
function computeFrequency(data){
  const freq = Array(40).fill(0);
  data.forEach(row=>{
    row.numbers.forEach(n => freq[parseInt(n)]++);
  });
  return freq;
}

// L1 強化策略
function generatePredictionL1(freq){
  let nums = [];
  let sorted = freq.map((c,n)=>({n,c})).filter(x=>x.n>0).sort((a,b)=>b.c - a.c);
  const ranges = [[1,13],[14,26],[27,39]];
  ranges.forEach(r=>{
    let pick = sorted.filter(x=>x.n>=r[0] && x.n<=r[1]).map(x=>x.n);
    for(let n of pick){
      if(nums.length<5 && !nums.includes(n)) nums.push(n);
    }
  });
  // 避免重複上期號碼
  if(csvData.length>0){
    const lastNumbers = csvData[csvData.length-1].numbers.map(Number);
    nums = nums.map(n=>lastNumbers.includes(n)?n+1>39?n-1:n:n);
  }
  if(nums.length<5){
    sorted.forEach(x=>{ if(!nums.includes(x.n) && nums.length<5) nums.push(x.n); });
  }
  return nums;
}

// L2_new2 替代策略
function generatePredictionL2_new2(freq){
  let sorted = freq.map((c,n)=>({n,c})).filter(x=>x.n>0).sort((a,b)=>b.c - a.c);
  let high = sorted.slice(0,10).map(x=>x.n);
  let low = sorted.slice(-10).map(x=>x.n);
  let mid = sorted.slice(10,30).map(x=>x.n);
  let recentHot = csvData.slice(-5).flatMap(r=>r.numbers).map(Number).sort((a,b)=> mid.includes(a)?-1:1);
  let nums = [];
  nums.push(...high.slice(0,2));
  nums.push(...low.slice(0,2));
  nums.push(recentHot[0]);
  return nums;
}

// L3 強化策略
function generatePredictionL3(freq){
  let nums = [];
  let sorted = freq.map((c,n)=>({n,c})).filter(x=>x.n>0).sort((a,b)=>b.c - a.c);
  const ranges = [[1,13],[14,26],[27,39]];
  ranges.forEach(r=>{
    let pick = sorted.filter(x=>x.n>=r[0] && x.n<=r[1]).map(x=>x.n);
    for(let n of pick){
      if(nums.length<5 && !nums.includes(n)) nums.push(n);
    }
  });
  // 最近熱門號碼補充
  let recentHot = csvData.slice(-5).flatMap(r=>r.numbers).map(Number);
  recentHot.forEach(n=>{ if(nums.length<5 && !nums.includes(n)) nums.push(n); });
  if(nums.length<5){
    sorted.forEach(x=>{ if(!nums.includes(x.n) && nums.length<5) nums.push(x.n); });
  }
  return nums;
}

// 計算命中數
function hitCount(actual, pred){
  return pred.filter(n => actual.includes(n.toString())).length;
}

// 回測
function runBacktest(){
  backtestResults = [];
  const freq = computeFrequency(csvData);
  csvData.forEach(row=>{
    const l1 = generatePredictionL1(freq);
    const l2 = generatePredictionL2_new2(freq);
    const l3 = generatePredictionL3(freq);
    backtestResults.push({date:row.date, actual:row.numbers, strategy:'L1', pred:l1, hits:hitCount(row.numbers,l1)});
    backtestResults.push({date:row.date, actual:row.numbers, strategy:'L2_new2', pred:l2, hits:hitCount(row.numbers,l2)});
    backtestResults.push({date:row.date, actual:row.numbers, strategy:'L3', pred:l3, hits:hitCount(row.numbers,l3)});
  });
  document.getElementById('backtestCount').innerText = `回測筆數：${backtestResults.length}`;
  updateLog();
  updateNextPrediction();
}

// 更新 Log
function updateLog(){
  const select = document.getElementById('strategySelect').value;
  const logBody = document.getElementById('backtestLog');
  logBody.innerHTML = '';
  const filtered = backtestResults.filter(r=>r.strategy===select).slice(-30).reverse();
  filtered.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.actual.join(',')}</td><td>${r.pred.join(',')}</td><td>${r.hits}</td>`;
    logBody.appendChild(tr);
  });
  const recent5 = backtestResults.filter(r=>r.strategy===select).slice(-5);
  const twoStarHits = recent5.filter(x=>x.hits===2).length;
  const rate = recent5.length>0 ? (twoStarHits / recent5.length * 100).toFixed(1) + '%' : '--';
  document.getElementById('recent5Rate').innerText = `近5期命中率: ${rate}`;
}

// 下期預測號碼
function updateNextPrediction(){
  const select = document.getElementById('strategySelectPrediction').value;
  const freq = computeFrequency(csvData);
  let pred = [];
  if(select==='L1') pred = generatePredictionL1(freq);
  else if(select==='L2_new2') pred = generatePredictionL2_new2(freq);
  else if(select==='L3') pred = generatePredictionL3(freq);
  document.getElementById('nextPrediction').innerText = `預測號碼: ${pred.join(',')}`;
}

</script>
</body>
</html>
