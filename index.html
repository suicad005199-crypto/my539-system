<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>539 æ•¸æ“šæ ¸å¿ƒ v6.2</title>
    <style>
        :root { --bg: #0a192f; --card: #172a45; --gold: #c5a059; --cyan: #64ffda; --text: #e6f1ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        .header { padding: 12px; text-align: center; border-bottom: 1px solid #233554; flex-shrink: 0; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        
        /* é¢æ¿èˆ‡å¡ç‰‡ */
        .panel { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid #233554; }
        .panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .info-box { text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .label { font-size: 0.65rem; color: #8892b0; margin-bottom: 2px; }
        .val { font-size: 1rem; font-weight: bold; color: var(--gold); }

        /* Log é¢æ¿å„ªåŒ– */
        .log-panel { border: 1px solid var(--gold); }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        select { background: var(--bg); color: var(--gold); border: 1px solid var(--gold); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; outline: none; }
        .log-list { height: 160px; overflow-y: auto; font-size: 0.65rem; font-family: monospace; }
        .log-item { display: grid; grid-template-columns: 1.2fr 1.8fr 1.8fr 0.6fr; gap: 4px; padding: 6px 0; border-bottom: 1px solid #ffffff08; align-items: center; }
        .hit-tag { color: var(--cyan); font-weight: bold; }

        /* ç­–ç•¥çƒé«” */
        .ball-row { display: flex; gap: 4px; justify-content: space-between; margin-top: 8px; }
        .ball { width: 18%; aspect-ratio: 1/1; background: var(--gold); border-radius: 50%; color: var(--bg); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1rem; }

        .footer { padding: 10px 15px calc(5px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        .main-btn { width: 100%; padding: 16px; border-radius: 30px; border: none; background: var(--gold); color: var(--bg); font-size: 1rem; font-weight: bold; }
        .upload-btn { background: rgba(197, 160, 89, 0.1); border: 1px dashed var(--gold); color: var(--gold); padding: 12px; border-radius: 10px; text-align: center; margin-bottom: 10px; cursor: pointer; display: block; font-size: 0.9rem; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="header"><h1 style="font-size:1rem; color:var(--gold); margin:0;">539 æ•¸æ“šæ ¸å¿ƒ v6.2</h1></div>

<div class="scroll-area">
    <label class="upload-btn">ğŸ“‚ é»æ“Šä¸Šå‚³ CSV æª”æ¡ˆ<input type="file" accept=".csv" onchange="handleFile(this)"></label>

    <div class="panel-grid">
        <div class="panel info-box"><div class="label">è®€å–ç­†æ•¸</div><div id="cnt-csv" class="val">0</div></div>
        <div class="panel info-box"><div class="label">å›æ¸¬ç­†æ•¸</div><div id="cnt-bt" class="val">0</div></div>
    </div>

    <div class="panel log-panel">
        <div class="log-header">
            <span style="font-size: 0.8rem; font-weight: bold; color: var(--gold);">è¿‘ 30 æœŸç­–ç•¥ Log</span>
            <select id="stratSelect" onchange="updateLogView()"></select>
        </div>
        <div class="log-item" style="border-bottom: 1px solid var(--gold); color: #8892b0; font-weight: bold; font-size: 0.6rem;">
            <div>æ—¥æœŸ</div><div>é–‹çè™Ÿ</div><div>é æ¸¬è™Ÿ</div><div>ä¸­</div>
        </div>
        <div id="logList" class="log-list">è«‹ä¸Šå‚³è³‡æ–™...</div>
    </div>

    <div id="stratResults"></div>
</div>

<div class="footer">
    <button id="runBtn" class="main-btn" onclick="runAnalysis()" disabled>åŸ·è¡Œç­–ç•¥å›æ¸¬</button>
</div>

<script>
    let cleanHistory = [], dates = [], backtestRates = {};
    const strats = [
        { id: 'hot', name: 'é«˜é »æœ€å„ª (Top 5)', desc: 'å‡ºç¾é »ç‡æœ€é«˜æ’å' },
        { id: 'missing', name: 'éºæ¼è£œå„Ÿ (æœ€ä¹…æœªé–‹)', desc: 'è‡ªå‹•é–å®šæœ€é•·éºæ¼è™Ÿç¢¼' },
        { id: 'neighbors', name: 'é„°ä½è¯å‹• (é„°è™Ÿæ“´æ•£)', desc: 'ç†±è™ŸåŠå…¶ç›¸é„°æ•¸å­—' },
        { id: 'weighted', name: 'å¤šç¶­åŠ æ¬Š (å‹•èƒ½æ•´åˆ)', desc: 'ç¶œåˆè©•åˆ†æœ€é«˜çµ„åˆ' }
    ];

    // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    const sel = document.getElementById('stratSelect');
    strats.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`);

    function handleFile(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== '');
            cleanHistory = []; dates = [];
            
            lines.forEach((line) => {
                const cells = line.split(',');
                const nums = cells.map(v => parseInt(v.trim())).filter(n => n >= 1 && n <= 39);
                if (nums.length === 5) {
                    cleanHistory.push(nums);
                    dates.push(cells[0].trim()); 
                }
            });

            if (cleanHistory.length > 0) {
                document.getElementById('cnt-csv').innerText = cleanHistory.length;
                document.getElementById('cnt-bt').innerText = cleanHistory.length * 4;
                document.getElementById('runBtn').disabled = false;
                runAnalysis();
            }
        };
        reader.readAsText(input.files[0]);
    }

    function getNumbers(type, offset) {
        const subHistory = cleanHistory.slice(offset);
        if (subHistory.length < 1) return [1,2,3,4,5];

        let counts = {}, lastSeen = {};
        for(let i=1; i<=39; i++) { counts[i] = 0; lastSeen[i] = subHistory.length; }
        
        subHistory.forEach((draw, idx) => {
            draw.forEach(n => {
                counts[n]++;
                if (lastSeen[n] === subHistory.length) lastSeen[n] = idx;
            });
        });

        const sortedFreq = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(i=>parseInt(i[0]));
        const sortedMissing = Object.entries(lastSeen).sort((a,b)=>b[1]-a[1]).map(i=>parseInt(i[0]));

        if (type === 'hot') return sortedFreq.slice(0, 5);
        if (type === 'missing') return sortedMissing.slice(0, 5);
        if (type === 'neighbors') {
            const top = sortedFreq[0];
            return [top, top-1<1?39:top-1, top+1>39?1:top+1, sortedFreq[1], sortedFreq[2]];
        }
        return [...sortedFreq.slice(0, 3), ...sortedMissing.slice(0, 2)];
    }

    function runAnalysis() {
        strats.forEach(s => {
            let hits = 0, range = Math.min(100, cleanHistory.length - 1);
            for(let i=1; i<=range; i++) {
                if (getNumbers(s.id, i).filter(n => cleanHistory[i-1].includes(n)).length >= 2) hits++;
            }
            backtestRates[s.id] = ((hits / range) * 100).toFixed(2);
        });
        renderStrats();
        updateLogView();
    }

    function updateLogView() {
        const type = sel.value, list = document.getElementById('logList');
        list.innerHTML = '';
        for(let i=0; i<30; i++) {
            if(!cleanHistory[i+1]) break;
            const actual = cleanHistory[i], pred = getNumbers(type, i+1);
            const matches = pred.filter(n => actual.includes(n));
            list.innerHTML += `
                <div class="log-item">
                    <div style="color:#8892b0">${dates[i].split('/').slice(1).join('/')}</div>
                    <div>${actual.map(n=>n<10?'0'+n:n).join(',')}</div>
                    <div>${pred.slice(0,2).join(',')},..</div>
                    <div class="${matches.length>=2?'hit-tag':''}">ä¸­ ${matches.length}</div>
                </div>`;
        }
    }

    function renderStrats() {
        const container = document.getElementById('stratResults');
        container.innerHTML = strats.map(s => `
            <div class="panel" style="border-left:4px solid var(--gold)">
                <div style="display:flex; justify-content:space-between">
                    <div><b style="color:var(--gold); font-size:0.9rem;">${s.name}</b><br><small style="color:#8892b0">${s.desc}</small></div>
                    <div style="text-align:right"><small style="color:#8892b0">å›æ¸¬</small><br><b style="color:var(--cyan)">${backtestRates[s.id]}%</b></div>
                </div>
                <div class="ball-row">${getNumbers(s.id, 0).sort((a,b)=>a-b).map(n=>`<div class="ball">${n<10?'0'+n:n}</div>`).join('')}</div>
            </div>`).join('');
    }
</script>
</body>
</html>
