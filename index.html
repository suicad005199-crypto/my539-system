// --- 核心運算模組 ---

const ODDS = {
    two: 53,    // 二星賠率
    three: 570, // 三星賠率
    car: 5.57,  // 全車賠率
    miss5: 2.1  // 自選五不中(概估)
};

/**
 * 1. 遺漏值與冷熱統計模組
 * @param {Array} data - 歷史數據
 */
function analyzeFrequencyAndGaps(data) {
    const stats = {};
    for (let i = 1; i <= 39; i++) {
        stats[i] = { num: i, count: 0, gap: 0, lastIndex: -1 };
    }

    data.forEach((row, idx) => {
        row.nums.forEach(n => {
            stats[n].count++;
            stats[n].lastIndex = idx;
        });
    });

    const totalLen = data.length;
    for (let i = 1; i <= 39; i++) {
        stats[i].gap = stats[i].lastIndex === -1 ? totalLen : (totalLen - 1 - stats[i].lastIndex);
    }
    return Object.values(stats);
}

/**
 * 2. 期望值排序與策略生成
 * @param {Array} stats - 統計後的數據
 */
function getStrategyPicks(stats) {
    // 熱號池：頻率前 12 名
    const hots = [...stats].sort((a, b) => b.count - a.count).slice(0, 12).map(x => x.num);
    // 冷號池：遺漏值前 10 名
    const colds = [...stats].sort((a, b) => b.gap - a.gap).slice(0, 10).map(x => x.num);
    
    return {
        hot_impact: { name: "熱號衝擊", pick: hots.sort(() => 0.5 - Math.random()).slice(0, 5) },
        cold_rebound: { name: "冷號回補", pick: colds.sort(() => 0.5 - Math.random()).slice(0, 5) },
        balanced: { 
            name: "冷熱平衡", 
            pick: [
                ...hots.sort(() => 0.5 - Math.random()).slice(0, 3),
                ...colds.sort(() => 0.5 - Math.random()).slice(0, 2)
            ].sort((a, b) => a - b)
        }
    };
}

/**
 * 3. 獲利回測系統 (近 100 期)
 * @param {Array} fullData - 完整歷史數據
 */
function runBacktest(fullData) {
    const testCount = Math.min(100, fullData.length - 20);
    const results = {
        hot_impact: { name: "熱號衝擊", hit2: 0, hit3: 0, profit: 0 },
        cold_rebound: { name: "冷號回補", hit2: 0, hit3: 0, profit: 0 },
        balanced: { name: "冷熱平衡", hit2: 0, hit3: 0, profit: 0 }
    };

    // 模擬過去 100 期
    for (let i = fullData.length - testCount; i < fullData.length - 1; i++) {
        const historySnapshot = fullData.slice(0, i);
        const nextDraw = fullData[i + 1].nums;
        const stats = analyzeFrequencyAndGaps(historySnapshot);
        const strategies = getStrategyPicks(stats);

        for (let key in strategies) {
            const pick = strategies[key].pick;
            const matches = nextDraw.filter(n => pick.includes(n)).length;
            
            if (matches === 2) {
                results[key].hit2++;
                results[key].profit += ODDS.two;
            } else if (matches === 3) {
                results[key].hit3++;
                results[key].profit += ODDS.three;
            }
            results[key].profit -= 1; // 扣除每期成本
        }
    }

    // 計算評分 (Score) = 總收益 / 測試期數
    for (let key in results) {
        results[key].score = (results[key].profit / testCount).toFixed(2);
    }
    return results;
}

// --- UI 整合觸發函數 ---

async function startAnalysis() {
    const fileInput = document.getElementById("csvFile");
    if (!fileInput.files[0]) return alert("請載入 CSV 檔案");

    const text = await fileInput.files[0].text();
    const allData = parseCSV(text); // 假設 parseCSV 已經實作
    
    // 1. 執行回測
    const backtestResults = runBacktest(allData);
    
    // 2. 獲取當前最新推薦
    const currentStats = analyzeFrequencyAndGaps(allData);
    const currentPicks = getStrategyPicks(currentStats);

    // 3. 渲染回測表格
    renderBacktestTable(backtestResults);
    
    // 4. 渲染推薦號碼
    renderRecommendations(currentPicks, backtestResults);
}

function renderBacktestTable(results) {
    let html = `<table><tr><th>策略名稱</th><th>二星次數</th><th>三星次數</th><th>期望值評分</th></tr>`;
    for (let key in results) {
        const r = results[key];
        const color = r.score > 0 ? 'var(--success)' : 'var(--text)';
        html += `<tr>
            <td>${r.name}</td>
            <td>${r.hit2}</td>
            <td>${r.hit3}</td>
            <td style="color: ${color}; font-weight: bold;">${r.score}</td>
        </tr>`;
    }
    document.getElementById("backtestDisplay").innerHTML = html + "</table>";
}
