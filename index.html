<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸‰æ˜Ÿ-é æ¸¬ç³»çµ± v3.0 (è¬æ¬¡æ¨¡æ“¬ç‰ˆ)</title>
<style>
:root {
  --primary: #00ff99;
  --secondary: #274c77;
  --bg-0: #050b15;
  --bg-1: #0f1f38;
  --bg-2: #142b4d;
  --bg-3: #1a355c;
  --text-light: #e0f7ff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0b1626, #051122);
  color: var(--text-light);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 800px; margin: 0 auto; }
.header { text-align: center; padding: 30px; background: var(--bg-0); border-radius: 20px; margin-bottom: 20px; border-top: 4px solid var(--primary); }
.header h1 { color: var(--primary); margin-bottom: 8px; }
.panel { border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.05); }
.panel-1 { background: var(--bg-1); }
.panel-2 { background: var(--bg-2); }
.panel-4 { background: var(--bg-3); }
h2 { color: var(--primary); margin-bottom: 20px; font-size: 1.3rem; }
.file-input, .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; cursor: pointer; transition: 0.3s; border: none; }
.file-input { background: rgba(0,0,0,0.3); border: 2px dashed rgba(0,255,153,0.3); color: white; margin-bottom: 15px; }
.btn { background: var(--secondary); color: white; font-weight: bold; }
.btn-primary { background: var(--primary); color: var(--bg-0); margin-top: 10px; }
.btn:hover { transform: translateY(-2px); opacity: 0.9; }
.box { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; margin-top: 20px; }
.numbers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin: 15px 0; }
.number-ball { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: bold; background: #203f6e; }
.number-ball.predict { background: linear-gradient(135deg, var(--primary), #00cc7a); color: #050b15; box-shadow: 0 0 15px rgba(0,255,153,0.4); }
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
.stat-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; text-align: center; }
.status { padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; line-height: 1.5; }
.status.success { background: rgba(0, 255, 153, 0.1); border: 1px solid var(--primary); color: var(--primary); }
.loading { display: none; text-align: center; padding: 20px; }
.spinner { width: 30px; height: 30px; border: 3px solid rgba(0,255,153,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin: 10px auto; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ä¸‰æ˜Ÿ-é æ¸¬ç³»çµ± v3.0</h1>
    <p>Monte Carlo è¬æ¬¡æ¨¡æ“¬èšåˆæ¶æ§‹</p>
  </div>

  <div class="panel panel-1">
    <h2>ğŸ“Š æ•¸æ“šå°å…¥</h2>
    <input type="file" id="csvInput" class="file-input" accept=".csv">
    <div id="csvInfo"></div>
  </div>

  <div class="panel panel-2">
    <h2>ğŸ” æ•¸æ“šåˆ†æ</h2>
    <button class="btn" onclick="runAnalysis()">æ›´æ–°æ­·å²æ¬Šé‡</button>
    <div class="loading" id="loadingA"><div class="spinner"></div></div>
    <div id="panelA" style="display: none;"></div>
  </div>

  <div class="panel panel-4">
    <h2>ğŸ¯ æ¨¡æ“¬ç”Ÿæˆ</h2>
    <button class="btn btn-primary" onclick="generatePrediction()">åŸ·è¡Œè¬æ¬¡æ¨¡æ“¬é æ¸¬</button>
    <div class="loading" id="loadingC"><div class="spinner"></div>æ­£åœ¨é€²è¡Œ 10,000 æ¬¡çµ„åˆå¯¦é©—...</div>
    <div id="panelC" style="display: none;"></div>
  </div>
</div>

<script>
let data = [];
let analysisCache = null;

document.getElementById("csvInput").onchange = function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(event) {
    const lines = event.target.result.trim().split(/\r?\n/);
    data = [];
    lines.forEach((line, idx) => {
      if (idx === 0) return;
      const parts = line.split(",");
      if (parts.length >= 6) {
        data.push({ date: parts[0], numbers: parts.slice(1, 6).map(n => parseInt(n.trim())) });
      }
    });
    document.getElementById("csvInfo").innerHTML = `<div class="status success">æˆåŠŸè¼‰å…¥ ${data.length} æœŸæ•¸æ“š</div>`;
  };
  reader.readAsText(file);
};

function calculateStats() {
  const freq = {};
  const lastSeen = {};
  const sums = [];
  data.forEach((draw, idx) => {
    draw.numbers.forEach(n => {
      freq[n] = (freq[n] || 0) + 1;
      lastSeen[n] = idx;
    });
    sums.push(draw.numbers.reduce((a, b) => a + b, 0));
  });
  const avg = sums.reduce((a, b) => a + b, 0) / sums.length;
  return { frequency: freq, lastSeen, total: data.length, avgSum: avg };
}

function runAnalysis() {
  if (!data.length) return alert("è«‹å…ˆä¸Šå‚³ CSV");
  document.getElementById("loadingA").style.display = "block";
  setTimeout(() => {
    analysisCache = calculateStats();
    document.getElementById("panelA").style.display = "block";
    document.getElementById("panelA").innerHTML = `<div class="status success">æ­·å²æ¬Šé‡å·²æ›´æ–°ã€‚å¹³å‡å’Œå€¼ï¼š${Math.round(analysisCache.avgSum)}</div>`;
    document.getElementById("loadingA").style.display = "none";
  }, 500);
}

// æ ¸å¿ƒå„ªåŒ–ï¼šè¬æ¬¡æ¨¡æ“¬èšåˆ
function generatePrediction() {
  if (!data.length) return alert("è«‹å°å…¥æ•¸æ“š");
  document.getElementById("loadingC").style.display = "block";
  document.getElementById("panelC").style.display = "none";

  setTimeout(() => {
    if (!analysisCache) analysisCache = calculateStats();
    const stats = analysisCache;
    const SIM_COUNT = 10000;
    
    // 1. å»ºç«‹æ¬Šé‡æ± 
    let pool = [];
    for (let i = 1; i <= 39; i++) {
      const f = stats.frequency[i] || 0;
      const daysSince = stats.total - (stats.lastSeen[i] || 0);
      const score = (f / stats.total) * 500 + Math.min(daysSince * 1.8, 50);
      pool.push({ num: i, score });
    }

    // 2. è¬æ¬¡å¾ªç’°æŠ½æ¨£
    let counter = Array(40).fill(0);
    let successSims = 0;

    for (let s = 0; s < SIM_COUNT; s++) {
      let pick = [];
      let tempPool = [...pool];
      for (let i = 0; i < 5; i++) {
        let totalW = tempPool.reduce((sum, c) => sum + c.score, 0);
        let rand = Math.random() * totalW;
        let acc = 0;
        for (let j = 0; j < tempPool.length; j++) {
          acc += tempPool[j].score;
          if (rand <= acc) {
            pick.push(tempPool[j].num);
            tempPool.splice(j, 1);
            break;
          }
        }
      }

      const sum = pick.reduce((a, b) => a + b, 0);
      const odd = pick.filter(n => n % 2 === 1).length;
      
      // åš´æ ¼ç´„æŸï¼šç¬¦åˆæ­·å²å’Œå€¼ä¸­å¿ƒä¸”å¥‡å¶å¹³è¡¡
      if (Math.abs(sum - stats.avgSum) <= 15 && (odd === 2 || odd === 3)) {
        pick.forEach(n => counter[n]++);
        successSims++;
      }
    }

    // 3. æå–å…±è­˜è™Ÿç¢¼
    const finalNums = counter
      .map((count, num) => ({ num, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5)
      .map(x => x.num)
      .sort((a, b) => a - b);

    displayPrediction(finalNums, successSims);
    document.getElementById("loadingC").style.display = "none";
  }, 300);
}

function displayPrediction(nums, validCount) {
  const container = document.getElementById("panelC");
  container.style.display = "block";
  const sum = nums.reduce((a, b) => a + b, 0);
  container.innerHTML = `
    <div class="box">
      <div class="box-title">ğŸ† è¬æ¬¡æ¨¡æ“¬èšåˆçµ„åˆ</div>
      <div class="numbers-grid">${nums.map(n => `<div class="number-ball predict">${n}</div>`).join('')}</div>
      <div class="status success">
        <b>å…±è­˜åˆ†æå®Œæˆï¼š</b><br>
        åœ¨ 10,000 æ¬¡æ¨¡æ“¬ä¸­ï¼Œç¯©é¸å‡º ${validCount} çµ„ç¬¦åˆæ­·å²è¦å¾‹çš„æœ‰æ•ˆæ¨£æœ¬ã€‚<br>
        ä¸Šæ–¹ç‚ºæœ‰æ•ˆæ¨£æœ¬ä¸­å‡ºç¾é »ç‡æœ€é«˜çš„æ ¸å¿ƒè™Ÿç¢¼ã€‚
      </div>
      <div class="stats-row">
        <div class="stat-item"><div class="stat-label">çµ„åˆå’Œå€¼</div><div class="stat-value">${sum}</div></div>
        <div class="stat-item"><div class="stat-label">æ¨¡æ“¬æˆåŠŸç‡</div><div class="stat-value">${(validCount/100).toFixed(1)}%</div></div>
      </div>
    </div>
  `;
}
</script>
</body>
</html>
