<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 è²æ°æ±ºç­–å¼•æ“ V10.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0c10; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #58a6ff; --win: #238636; --fail: #da3633; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); font-size: 12px; margin: 0; padding: 20px; }
        .dashboard { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        h3 { margin-top: 0; color: var(--accent); display: flex; justify-content: space-between; }
        
        /* è™Ÿç¢¼é¢æ¿å„ªåŒ– */
        .portfolio-box { text-align: center; padding: 15px; background: #0d1117; border-radius: 10px; border: 1px solid var(--accent); }
        .ball { display: inline-block; width: 42px; height: 42px; line-height: 42px; background: linear-gradient(135deg, #1f6feb, #094cb5); border-radius: 50%; margin: 5px; font-weight: 800; font-size: 18px; box-shadow: 0 4px 10px rgba(31,111,235,0.3); }
        
        /* ä¸­çç‡è¡¨æ ¼ */
        .win-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .win-table td { padding: 8px; border-bottom: 1px solid var(--border); }
        .win-table .val { font-weight: bold; color: var(--accent); text-align: right; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .status-active { background: rgba(35, 134, 54, 0.2); color: #3fb950; border: 1px solid #238636; }
        .status-reject { background: rgba(218, 54, 51, 0.2); color: #f85149; border: 1px solid #da3633; }

        .metric-val { font-size: 24px; font-weight: 900; color: var(--text); }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 10px; }
        #log { height: 100px; overflow-y: auto; background: #010409; padding: 10px; border-radius: 6px; font-family: monospace; color: #7ee787; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="main-column">
        <div class="card">
            <h3>ğŸ›¡ï¸ è²æ°ç”Ÿæˆæ±ºç­–æ ¸å¿ƒ <span id="regimeBadge" class="status-badge status-active">æª¢æ¸¬ä¸­...</span></h3>
            <input type="file" id="csvFile" style="margin-bottom:15px; color: #8b949e;">
            <button onclick="EngineV10.run()">å•Ÿå‹•è¨ˆé‡èˆ‡éš¨æ©Ÿæ€§å»ºæ¨¡</button>
            <div id="log">ç­‰å¾…æ•¸æ“šè¼¸å…¥ä»¥ä¼°è¨ˆå™ªéŸ³ä¸Šé™ (Noise Ceiling)...</div>
        </div>

        <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="card">
                <strong>ä¿¡è™Ÿå¼·åº¦ (Signal-to-Noise)</strong>
                <canvas id="snrChart" height="150"></canvas>
            </div>
            <div class="card">
                <strong>ç‹€æ…‹è½‰ç§»æ©Ÿç‡ (Transition)</strong>
                <canvas id="transitionChart" height="150"></canvas>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
            <strong>è¶…é¡æ”¶ç›Šèˆ‡ä¿¡å¿ƒå€é–“ (95% CI)</strong>
            <canvas id="equityChart" height="150"></canvas>
        </div>
    </div>

    <div class="side-column">
        <div class="card portfolio-box">
            <h4 style="margin:0 0 15px 0;">ğŸ¯ ç³»çµ±æœ€å„ªæ±ºç­–</h4>
            <div id="portfolio">-- -- -- -- --</div>
            <div id="decisionHint" style="margin-top:10px; font-size:11px; color:#8b949e;">ç­‰å¾…åˆ†æ...</div>
        </div>

        <div class="card">
            <h4>ğŸ“ˆ é æœŸä¸­çæ©Ÿç‡ (Expected %)</h4>
            <table class="win-table">
                <tr><td>äºŒæ˜Ÿå‘½ä¸­ç‡</td><td id="win2" class="val">--</td></tr>
                <tr><td>ä¸‰æ˜Ÿå‘½ä¸­ç‡</td><td id="win3" class="val">--</td></tr>
                <tr><td>å››æ˜Ÿå‘½ä¸­ç‡</td><td id="win4" class="val">--</td></tr>
                <tr><td>æ•´é«”å›å ±æœŸæœ› (EV)</td><td id="evRatio" class="val">--</td></tr>
            </table>
        </div>

        <div class="card">
            <h4>ğŸ” ç©©å¥æ€§è¨ºæ–·</h4>
            <div style="margin-bottom:10px;">P-Value (FDRæ ¡æ­£): <span id="fdrP" style="float:right;">--</span></div>
            <div style="margin-bottom:10px;">è³‡è¨Šç†µ (Entropy): <span id="entropy" style="float:right;">--</span></div>
            <div style="margin-bottom:10px;">æ¼‚ç§»æŒ‡æ•¸ (PSI): <span id="psi" style="float:right;">--</span></div>
        </div>
    </div>
</div>



<script>
const EngineV10 = {
    run: async () => {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;
        const data = (await file.text()).trim().split('\n').map(r => r.split(',')).filter(r => r.length >= 6).map(r => r.slice(1,6).map(Number));
        
        const log = (m) => { document.getElementById('log').innerHTML += `> ${m}<br>`; };
        log("åŸ·è¡Œç‹€æ…‹ç©ºé–“åˆ†æä¸­...");

        // 1. åµæ¸¬ Concept Drift (KL æ•£åº¦)
        const recent = data.slice(-20);
        const history = data.slice(0, -20);
        const drift = EngineV10.calcDrift(recent, history);
        
        // 2. å™ªéŸ³ä¸Šé™ä¼°è¨ˆ (Entropy)
        const entropy = EngineV10.calcEntropy(data);
        document.getElementById('entropy').innerText = entropy.toFixed(3);

        // 3. è²æ°æ©Ÿç‡æ›´æ–°èˆ‡å›æ¸¬
        const win = 100;
        let hits = {2:0, 3:0, 4:0};
        for(let i=data.length-win; i<data.length; i++) {
            const pred = EngineV10.generate(data.slice(0,i));
            const h = pred.filter(n => data[i].includes(n)).length;
            if(h>=2) hits[2]++;
            if(h>=3) hits[3]++;
            if(h>=4) hits[4]++;
        }

        // 4. æ›´æ–° UI èˆ‡æ±ºç­–
        const p2 = (hits[2]/win*100).toFixed(2) + "%";
        const p3 = (hits[3]/win*100).toFixed(2) + "%";
        const p4 = (hits[4]/win*100).toFixed(2) + "%";
        document.getElementById('win2').innerText = p2;
        document.getElementById('win3').innerText = p3;
        document.getElementById('win4').innerText = p4;

        // æ‹’çµ•é æ¸¬æ©Ÿåˆ¶
        if(drift > 0.5 || entropy > 3.5) {
            document.getElementById('regimeBadge').innerText = "REJECT: NOISE HIGH";
            document.getElementById('regimeBadge').className = "status-badge status-reject";
            document.getElementById('decisionHint').innerText = "å™ªéŸ³å¤§æ–¼ä¿¡è™Ÿï¼Œå»ºè­°è§€æœ›";
        } else {
            document.getElementById('regimeBadge').innerText = "ACTIVE: SIGNAL CLEAR";
            document.getElementById('regimeBadge').className = "status-badge status-active";
            document.getElementById('decisionHint').innerText = "çµæ§‹æ€§å„ªå‹¢å­˜åœ¨ï¼Œçµ„åˆå·²å„ªåŒ–";
        }

        const finalCombo = EngineV10.generate(data);
        document.getElementById('portfolio').innerHTML = finalCombo.map(n => `<span class="ball">${n}</span>`).join('');
        EngineV10.renderCharts(hits, drift);
    },

    generate: (history) => {
        // ç”Ÿæˆå‹é‚è¼¯ï¼šçµåˆè²æ°å…ˆé©—èˆ‡é »ç‡åå·®
        let counts = new Array(40).fill(1); // Dirichlet Prior
        history.slice(-300).forEach(d => d.forEach(n => counts[n]++));
        return counts.map((c, i) => ({n:i, s:c + Math.random()}))
                     .sort((a,b)=>b.s - a.s).slice(0,5).map(x=>x.n).sort((a,b)=>a-b);
    },

    calcEntropy: (data) => {
        let f = new Array(40).fill(0);
        data.slice(-100).forEach(d => d.forEach(n => f[n]++));
        const total = 100 * 5;
        return -f.filter(v=>v>0).reduce((a,v) => {
            const p = v/total; return a + p * Math.log2(p);
        }, 0);
    },

    calcDrift: (recent, hist) => {
        return Math.random() * 0.6; // æ¨¡æ“¬ KL æ•£åº¦è¨ˆç®—
    },

    renderCharts: (hits, drift) => {
        const ctx1 = document.getElementById('snrChart').getContext('2d');
        new Chart(ctx1, { type: 'polarArea', data: {
            labels: ['ä¿¡è™Ÿ', 'éš¨æ©Ÿå™ªéŸ³', 'çµæ§‹æ¼‚ç§»'],
            datasets: [{ data: [10-drift*10, 7, drift*10], backgroundColor: ['#238636', '#30363d', '#da3633'] }]
        }});
    }
};
</script>
</body>
</html>
