<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>539 ç‰ˆè·¯åˆ†æå°ˆæ¥­ç‰ˆ</title>
    <style>
        :root { --bg: #0b0f1a; --card: #161b2d; --accent: #00d2ff; --selected: #ffcc00; --grid-border: #2d3548; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: #e2e8f0; font-family: -apple-system, system-ui, sans-serif; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 600px; padding: 12px; }
        
        .section { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--grid-border); }
        h3 { margin: 0 0 8px 0; font-size: 13px; color: var(--accent); letter-spacing: 1px; }

        /* èµ°å‹¢åœ–çœ‹æ¿ */
        .trend-container { overflow-x: auto; display: block; white-space: nowrap; background: #000; border-radius: 8px; padding: 5px; }
        .trend-grid { display: inline-grid; grid-template-columns: repeat(30, 18px); gap: 2px; text-align: center; }
        .trend-cell { width: 18px; height: 18px; font-size: 9px; line-height: 18px; border-radius: 2px; color: #fff; }
        .is-odd { background: #ff4757; } .is-even { background: #2f3542; }
        .is-big { background: #ffa502; } .is-small { background: #3742fa; }
        .trend-label { font-size: 10px; color: #94a3b8; margin-top: 4px; display: flex; gap: 10px; }

        /* é¸è™Ÿçƒè¦–è¦º */
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        .ball { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .ball span { font-size: 15px; font-weight: 800; }
        .ball small { font-size: 9px; font-weight: normal; margin-top: 2px; }
        .ball.active { background: var(--selected) !important; color: #000 !important; transform: scale(1.05); box-shadow: 0 0 15px var(--selected); }

        /* ç‹€æ…‹é¡¯ç¤º */
        .res-bar { background: linear-gradient(135deg, #1e293b, #0f172a); padding: 15px; border-radius: 15px; text-align: center; font-size: 26px; color: var(--selected); font-family: 'Courier New', monospace; margin-bottom: 15px; border: 1px solid var(--selected); }
        .btn-upload { display: block; padding: 8px; border: 1px dashed var(--accent); border-radius: 8px; text-align: center; color: var(--accent); cursor: pointer; font-size: 12px; margin-bottom: 10px; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--accent); color: #000; }
    </style>
</head>
<body>

<div class="app">
    <label class="btn-upload" for="csv">é»æ“Šä¸Šå‚³æ­·å²æ•¸æ“š CSV</label>
    <input type="file" id="csv" style="display:none" onchange="handleFile(this)">

    <div class="section">
        <h3>æ­·å² 30 æœŸèµ°å‹¢åœ– (å·¦æ–°å³èˆŠ)</h3>
        <div class="trend-container">
            <div class="trend-grid" id="trend_oe"></div>
            <div class="trend-grid" id="trend_bs" style="margin-top:4px"></div>
        </div>
        <div class="trend-label">
            <span>ğŸ”´å¥‡/âš«å¶</span> | <span>ğŸŸ å¤§/ğŸ”µå°</span>
        </div>
    </div>

    <div class="res-bar" id="res_num">00 00 00 00 00</div>

    <div class="section">
        <h3>è™Ÿç¢¼ç†±åº¦åˆ†ä½ˆ (æ·±ç´…è¶Šç†± / è—é»‘è¶Šå†·)</h3>
        <div class="grid" id="grid"></div>
    </div>

    <button onclick="smartPick()">æ™ºæ…§éš¨æ©Ÿé¸ç‰Œ</button>
</div>

<script>
    let freqMap = {};
    let lastSeen = {};
    let historyStats = [];
    let selected = new Set();

    function handleFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => parse(e.target.result);
        reader.readAsText(input.files[0]);
    }

    function parse(text) {
        const lines = text.split(/\n/).filter(l => l.trim() !== "").slice(1);
        freqMap = {}; historyStats = [];
        for(let i=1; i<=39; i++) lastSeen[i] = lines.length;

        lines.forEach((line, idx) => {
            const cols = line.split(',');
            const nums = cols.slice(1,6).map(Number).filter(n => n >= 1 && n <= 39);
            if(nums.length === 5) {
                // èµ°å‹¢æ•¸æ“š
                const oddCount = nums.filter(n => n % 2 !== 0).length;
                const bigCount = nums.filter(n => n >= 20).length;
                historyStats.push({ odd: oddCount, big: bigCount });
                
                nums.forEach(n => {
                    freqMap[n] = (freqMap[n] || 0) + 1;
                    if(lastSeen[n] > idx) lastSeen[n] = idx;
                });
            }
        });
        renderAll();
    }

    function renderAll() {
        // 1. èµ°å‹¢åœ–
        const oeDiv = document.getElementById('trend_oe');
        const bsDiv = document.getElementById('trend_bs');
        oeDiv.innerHTML = bsDiv.innerHTML = '';
        
        historyStats.slice(0, 30).forEach(s => {
            const c1 = document.createElement('div');
            c1.className = `trend-cell ${s.odd >= 3 ? 'is-odd' : 'is-even'}`;
            c1.innerText = s.odd;
            oeDiv.appendChild(c1);

            const c2 = document.createElement('div');
            c2.className = `trend-cell ${s.big >= 3 ? 'is-big' : 'is-small'}`;
            c2.innerText = s.big;
            bsDiv.appendChild(c2);
        });

        // 2. è™Ÿç¢¼çƒ (æ¼¸å±¤é¡è‰²)
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const maxFreq = Math.max(...Object.values(freqMap), 1);

        for(let i=1; i<=39; i++) {
            const count = freqMap[i] || 0;
            const ratio = count / maxFreq;
            // è¨ˆç®—ç†±åº¦é¡è‰²: 0% -> è—é»‘, 100% -> æ·±ç´…
            const r = Math.floor(20 + ratio * 200);
            const g = Math.floor(30 + ratio * 50);
            const b = Math.floor(60 - ratio * 40);

            const ball = document.createElement('div');
            ball.className = `ball ${selected.has(i) ? 'active' : ''}`;
            ball.style.background = `rgb(${r},${g},${b})`;
            ball.innerHTML = `<span>${i.toString().padStart(2,'0')}</span><small>${lastSeen[i]}æœŸ</small>`;
            ball.onclick = () => {
                if(selected.has(i)) selected.delete(i);
                else if(selected.size < 5) selected.add(i);
                renderAll();
                updateRes();
            };
            grid.appendChild(ball);
        }
    }

    function updateRes() {
        const arr = Array.from(selected).sort((a,b)=>a-b);
        document.getElementById('res_num').innerText = arr.length ? arr.map(n=>n.toString().padStart(2,'0')).join(' ') : '00 00 00 00 00';
    }

    function smartPick() {
        selected.clear();
        let pool = [];
        for(let i=1; i<=39; i++) {
            let weight = 1 + (freqMap[i] || 0) * 2;
            if(lastSeen[i] > 10) weight += 5; // è£œå„Ÿå†·è™Ÿæ©Ÿç‡
            for(let w=0; w<weight; w++) pool.push(i);
        }
        while(selected.size < 5) selected.add(pool[Math.floor(Math.random() * pool.length)]);
        renderAll();
        updateRes();
    }

    function renderEmpty() {
        // åˆå§‹åŒ–ç©ºçƒ
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for(let i=1; i<=39; i++){
            const b = document.createElement('div');
            b.className = 'ball';
            b.style.background = '#2d3548';
            b.innerHTML = `<span>${i.toString().padStart(2,'0')}</span><small>-</small>`;
            grid.appendChild(b);
        }
    }
    renderEmpty();
</script>
</body>
</html>
