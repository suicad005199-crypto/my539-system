<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 Strategy Commander Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #0ea5e9; --hot: #ef4444; --cold: #3b82f6; --gold: #fbbf24; --success: #22c55e; --con: #8b5cf6; }
        body { margin: 0; background: var(--bg); color: #f1f5f9; font-family: system-ui, sans-serif; padding: 10px; font-size: 13px; }
        .dashboard { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 1fr 520px; gap: 12px; }
        .panel { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid #1e293b; }
        .full { grid-column: 1 / -1; }
        
        /* 圖表區佈局 */
        .chart-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 12px; height: 240px; }

        /* 球盤交互與視覺強化 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(82px, 1fr)); gap: 8px; }
        .ball { 
            aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; position: relative; background: #1e293b; border: 2px solid transparent; overflow: hidden;
        }
        .ball.locked { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .ball.excluded { opacity: 0.3; border-color: var(--hot); text-decoration: line-through; }
        .ball .num { font-size: 20px; font-weight: 800; z-index: 2; }
        .ball .gap-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: var(--accent); transition: width 0.5s; }
        .ball .heat-bg { position: absolute; inset: 0; background: var(--hot); opacity: 0; transition: opacity 0.5s; }

        /* 方案卡片 */
        .plan-card { background: #1e293b; padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid #334155; display: grid; grid-template-columns: 1fr 140px; gap: 10px; }
        .plan-nums { display: flex; gap: 5px; margin-bottom: 8px; }
        .p-num { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; background: #0f172a; }
        .p-num.is-top { border: 1px solid var(--hot); color: var(--hot); }
        
        .mini-hit-map { display: flex; height: 12px; background: #0f172a; border-radius: 6px; overflow: hidden; margin-top: 5px; }
        .hit-bar { height: 100%; transition: width 0.5s; }

        /* 控制列 */
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-ai { background: linear-gradient(135deg, var(--accent), var(--con)); color: white; width: 100%; height: 45px; margin-top: 10px; }
        select { background: #1e293b; color: #fff; border: 1px solid #334155; padding: 5px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="panel full">
        <div class="ctrl-row">
            <h3 style="margin:0">戰略指揮看板 (和值趨勢 + Top10 深度回測)</h3>
            <input type="file" onchange="process(this)">
        </div>
        <div class="chart-grid">
            <canvas id="trendChart"></canvas>
            <canvas id="depthChart"></canvas>
        </div>
    </div>

    <div class="panel">
        <div class="ctrl-row">
            <b>智能球盤 (點擊:鎖定 | 長按/右鍵:排除)</b>
            <span id="ai-info" style="color:var(--gold)">等待數據...</span>
        </div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="panel">
        <h3>策略方案生成</h3>
        <div class="ctrl-row">
            <span>策略模式</span>
            <select id="s-mode">
                <option value="balanced">平衡穩定 (熱冷結合)</option>
                <option value="aggressive">激進追熱 (核心集中)</option>
                <option value="cold">冷門反彈 (遺漏補償)</option>
            </select>
        </div>
        <button class="btn-ai" onclick="generate()">執行多組方案生成</button>
        <div id="plan-list"></div>
    </div>
</div>

<script>
    let raw = [], scores = {}, stats = { freq: {}, gap: {}, con: {} }, locked = new Set(), excluded = new Set(), charts = {};

    function process(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.trim().split('\n').slice(1);
            stats.freq = {}; stats.gap = {}; stats.con = {};
            for(let i=1; i<=39; i++) stats.gap[i] = lines.length;

            raw = lines.map((l, idx) => {
                const c = l.split(',');
                const nums = c.slice(1,6).map(Number).sort((a,b)=>a-b);
                nums.forEach((n, i) => {
                    stats.freq[n] = (stats.freq[n]||0)+1;
                    if(stats.gap[n] > idx) stats.gap[n] = idx;
                    if(i > 0 && nums[i]-nums[i-1] === 1) stats.con[n] = (stats.con[n]||0)+1;
                });
                return { date: c[0].slice(5), nums, sum: nums.reduce((a,b)=>a+b,0) };
            }).reverse();

            updateScores();
            renderAll();
        };
        reader.readAsText(input.files[0]);
    }

    function updateScores() {
        for(let i=1; i<=39; i++) {
            scores[i] = (stats.freq[i]||0)*1.8 + (stats.gap[i]||0)*1.4 + (stats.con[i]||0)*1.1;
        }
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const maxG = Math.max(...Object.values(stats.gap)), maxF = Math.max(...Object.values(stats.freq));
        
        for(let i=1; i<=39; i++) {
            const ball = document.createElement('div');
            ball.className = `ball ${locked.has(i)?'locked':''} ${excluded.has(i)?'excluded':''}`;
            ball.innerHTML = `
                <div class="heat-bg" style="opacity:${(stats.freq[i]/maxF)*0.4}"></div>
                <div class="gap-bar" style="width:${(stats.gap[i]/maxG)*100}%"></div>
                <span class="num">${String(i).padStart(2,'0')}</span>
                <span style="font-size:8px; opacity:0.5; z-index:2">S:${scores[i].toFixed(0)}</span>
            `;
            ball.onclick = () => { 
                if(locked.has(i)) locked.delete(i); 
                else if(!excluded.has(i) && locked.size < 5) locked.add(i); 
                renderGrid(); 
            };
            ball.oncontextmenu = (e) => { 
                e.preventDefault();
                if(excluded.has(i)) excluded.delete(i);
                else { excluded.add(i); locked.delete(i); }
                renderGrid();
            };
            grid.appendChild(ball);
        }
    }

    function generate() {
        const mode = document.getElementById('s-mode').value;
        const list = document.getElementById('plan-list'); list.innerHTML = '';
        const top10 = Object.entries(scores).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(x=>Number(x[0]));
        
        let pool = [];
        Object.entries(scores).forEach(([n, s]) => {
            let weight = Math.floor(s);
            let num = Number(n);
            if(excluded.has(num)) weight = 0;
            if(locked.has(num)) weight *= 10;
            if(mode === 'aggressive' && top10.includes(num)) weight *= 2;
            if(mode === 'cold' && stats.gap[num] > 10) weight *= 2;
            for(let k=0; k<weight; k++) pool.push(num);
        });

        for(let i=0; i<3; i++) {
            let temp = new Set(locked);
            while(temp.size < 5 && pool.length > 5) temp.add(pool[Math.floor(Math.random()*pool.length)]);
            let arr = Array.from(temp).sort((a,b)=>a-b);
            
            // 方案命中圖數據 (最近10/30/50期)
            const depths = [10, 30, 50];
            const hits = depths.map(d => {
                let h = 0;
                raw.slice(-d).forEach(p => h += p.nums.filter(n => arr.includes(n)).length);
                return (h / d).toFixed(2);
            });

            const card = document.createElement('div');
            card.className = 'plan-card';
            card.innerHTML = `
                <div>
                    <div class="plan-nums">${arr.map(n => `<div class="p-num ${top10.includes(n)?'is-top':''}">${String(n).padStart(2,'0')}</div>`).join('')}</div>
                    <div style="font-size:10px; color:#94a3b8">核心佔比: ${arr.filter(n=>top10.includes(n)).length}/5</div>
                    <div class="mini-hit-map">
                        <div class="hit-bar" style="width:${hits[0]*20}%; background:var(--hot)"></div>
                        <div class="hit-bar" style="width:${hits[1]*20}%; background:var(--gold)"></div>
                        <div class="hit-bar" style="width:${hits[2]*20}%; background:var(--success)"></div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-weight:bold; color:var(--success)">穩健分: ${(hits[0]*0.5+hits[1]*0.5).toFixed(2)}</div>
                    <div style="font-size:9px; opacity:0.5; margin-top:10px">方案推薦 ${i+1}</div>
                </div>
            `;
            list.appendChild(card);
        }
    }

    function renderAll() {
        renderGrid();
        const data = raw.slice(-25);
        const top10 = Object.entries(scores).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(x=>Number(x[0]));
        
        if(charts.trend) charts.trend.destroy();
        charts.trend = new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: { labels: data.map(d=>d.date), datasets: [{ label: '和值趨勢', data: data.map(d=>d.sum), borderColor: '#fbbf24', tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const dRes = [10, 30, 50].map(d => {
            let hits = 0;
            raw.slice(-d).forEach(p => hits += p.nums.filter(n => top10.includes(n)).length);
            return (hits / d).toFixed(2);
        });

        if(charts.depth) charts.depth.destroy();
        charts.depth = new Chart(document.getElementById('depthChart'), {
            type: 'bar',
            data: { labels: ['10期', '30期', '50期'], datasets: [{ label: 'Top10 平均命中', data: dRes, backgroundColor: ['#ef4444', '#fbbf24', '#22c55e'] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 5 } } }
        });
        document.getElementById('ai-info').innerText = `✅ AI 已優化數據`;
    }
</script>
</body>
</html>
