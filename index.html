<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 æ•¸æ“šæ™ºèƒ½æ±ºç­–ç³»çµ± Pro</title>
    <style>
        :root { --primary: #e63946; --secondary: #1d3557; --success: #2a9d8f; --warning: #f4a261; --gray: #f8fafc; }
        body { font-family: sans-serif; margin: 0; background: #f1f5f9; color: var(--secondary); font-size: 14px; }
        .header { background: var(--secondary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .card-header { background: var(--gray); padding: 12px 20px; font-weight: bold; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; }
        
        /* ç­–ç•¥å„€è¡¨æ¿ */
        .strategy-list { padding: 15px; }
        .strat-item { border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; position: relative; }
        .prob-badge { position: absolute; top: 10px; right: 10px; text-align: right; }
        .prob-main { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        .conf-interval { font-size: 0.75rem; color: #64748b; }
        
        .ball-row { display: flex; gap: 8px; margin: 10px 0; }
        .ball { width: 32px; height: 32px; line-height: 32px; background: #ffca3a; border-radius: 6px; text-align: center; font-weight: bold; }
        
        /* æ™‚é–“åºåˆ—åˆ†ææ¨™ç±¤ */
        .time-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: #e2e8f0; margin-right: 5px; }
        
        /* è¡¨æ ¼èˆ‡åœ–è¡¨é ç•™å€ */
        .scroll-x { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        th, td { border: 1px solid #f1f5f9; padding: 8px 4px; }
        .hit-dot { background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-block; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <div><strong>539 AI Strategy Lab</strong> <small>v3.0 Backtest-Driven</small></div>
    <input type="file" id="csvFile" accept=".csv" onchange="runEngine()">
</div>

<div class="container">
    <div class="left-col">
        <div class="card">
            <div class="card-header">ğŸ“… æ­·å²è¦å¾‹èˆ‡æ™‚é–“åºåˆ—åˆ†å¸ƒ</div>
            <div class="scroll-x" id="mainDist">
                <p style="padding: 40px; text-align:center;">ç­‰å¾… CSV æ•¸æ“šå°å…¥ä»¥å•Ÿå‹•åˆ†æå¼•æ“...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ¤– å¤šé‡ç­–ç•¥åŠ æ¬Šæ±ºç­– (Voting System)</div>
            <div class="strategy-list" id="aiStrategyOutput"></div>
        </div>
    </div>

    <div class="right-col">
        <div class="card">
            <div class="card-header">ğŸ“Š æ•¸æ“šç‰¹å¾µ</div>
            <div id="statsPanel" style="padding: 20px; line-height: 2;">
                è¼‰å…¥æª”æ¡ˆå¾Œé¡¯ç¤º...
            </div>
        </div>
    </div>
</div>

<script>
    let db = [];

    // --- å¼•æ“æ ¸å¿ƒ ---
    async function runEngine() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;
        const text = await file.text();
        db = text.split('\n').filter(r => r.trim()).map(r => {
            const cols = r.split(',');
            return {
                date: cols[0],
                nums: cols.slice(1, 6).map(n => parseInt(n)),
                rawDate: new Date(cols[0])
            };
        });
        
        renderAll();
    }

    function renderAll() {
        renderDistTable();
        renderAIStrategies();
        renderStats();
    }

    // --- ç­–ç•¥æ¼”ç®—æ³• (ML æ€ç¶­) ---
    function getWeightedHot() { return Object.keys(getFreq(db.slice(-20))).sort((a,b)=>b-a).slice(0,5).map(Number); }
    function getSmartCold() { return Object.keys(getFreq(db)).sort((a,b)=>a-b).slice(0,5).map(Number); }
    function getTailPattern() { return [8, 18, 28, 3, 13]; } // ç°¡åŒ–é‚è¼¯ï¼Œå¯¦å‹™ä¸Šæœƒè·‘ loop
    function getAdvancedConn() { return db[db.length-1].nums.map(n => (n+1)%39 || 39); }

    function getBalancedPortfolio() {
        const strats = [
            {func: getWeightedHot, weight: 0.35},
            {func: getSmartCold, weight: 0.25},
            {func: getTailPattern, weight: 0.25},
            {func: getAdvancedConn, weight: 0.15}
        ];
        const votes = {};
        strats.forEach(s => {
            s.func().forEach(n => votes[n] = (votes[n] || 0) + s.weight);
        });
        return Object.entries(votes).sort((a,b)=>b[1]-a[1]).slice(0,5).map(e=>parseInt(e[0]));
    }

    // --- çœŸå¯¦å‘½ä¸­ç‡å›æ¸¬ ---
    function backtest(portfolio) {
        let hits = 0;
        const trials = Math.min(db.length, 30); // ç”¨æœ€è¿‘ 30 æœŸå›æ¸¬
        for(let i=0; i<trials; i++) {
            const match = portfolio.filter(n => db[db.length-1-i].nums.includes(n)).length;
            if(match >= 2) hits++; // ä»¥å‘½ä¸­2é¡†ä»¥ä¸Šä½œç‚ºæœ‰æ•ˆæ©Ÿç‡åŸºæº–
        }
        const hitRate = hits / trials;
        const confidence = 1.96 * Math.sqrt(hitRate*(1-hitRate)/trials || 0.01);
        return {
            expected: (hitRate * 100).toFixed(1),
            range: `${Math.max(0, (hitRate-confidence)*100).toFixed(0)}% ~ ${Math.min(100, (hitRate+confidence)*100).toFixed(0)}%`
        };
    }

    // --- UI æ¸²æŸ“ ---
    function renderAIStrategies() {
        const mainPortfolio = getBalancedPortfolio();
        const bt = backtest(mainPortfolio);
        
        const html = `
            <div class="strat-item">
                <div class="prob-badge">
                    <div class="prob-main">${bt.expected}%</div>
                    <div class="conf-interval">ç½®ä¿¡å€é–“: ${bt.range}</div>
                </div>
                <div style="font-weight:bold; color:var(--success);">ğŸ† æ ¸å¿ƒåŠ æ¬Šå…±è­˜çµ„åˆ</div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">æ•´åˆç†±åº¦ã€å†·é–€è£œå„Ÿã€å°¾æ•¸èˆ‡é€£è™Ÿä¹‹æœ€å„ªè§£</div>
                <div class="ball-row">
                    ${mainPortfolio.sort((a,b)=>a-b).map(n => `<div class="ball">${n<10?'0'+n:n}</div>`).join('')}
                </div>
                <div class="time-tag">è¶¨å‹¢ï¼š${parseFloat(bt.expected) > 20 ? 'ğŸ“ˆ æŒçºŒçœ‹å¥½' : 'ğŸ“‰ é€²å…¥éœ‡ç›ª'}</div>
            </div>
        `;
        document.getElementById('aiStrategyOutput').innerHTML = html;
    }

    function renderDistTable() {
        const last10 = db.slice(-10).reverse();
        let html = `<table><thead><tr><th>æ—¥æœŸ/ç‰¹å¾µ</th>`;
        for(let i=1; i<=39; i++) html += `<th>${i}</th>`;
        html += `</tr></thead><tbody>`;
        
        last10.forEach(row => {
            const isWeekend = [0, 6].includes(row.rawDate.getDay()) ? 'é€±æœ«' : 'å¹³æ—¥';
            const isEnd = row.rawDate.getDate() > 20 ? 'æœˆåº•' : 'æœˆåˆ';
            html += `<tr>
                <td style="text-align:left; background:#f8fafc;">
                    <strong>${row.date}</strong><br>
                    <span class="time-tag">${isWeekend}</span><span class="time-tag">${isEnd}</span>
                </td>`;
            for(let i=1; i<=39; i++) {
                html += `<td>${row.nums.includes(i) ? `<span class="hit-dot">${i}</span>` : ''}</td>`;
            }
            html += `</tr>`;
        });
        document.getElementById('mainDist').innerHTML = html + `</tbody></table>`;
    }

    function renderStats() {
        const stats = document.getElementById('statsPanel');
        const lastDate = db[db.length-1].rawDate;
        stats.innerHTML = `
            <div><strong>è³‡æ–™ç­†æ•¸ï¼š</strong> ${db.length} æœŸ</div>
            <div><strong>æœ€æ–°æ—¥æœŸï¼š</strong> ${db[db.length-1].date}</div>
            <div><strong>æ™‚é–“ç‰¹å¾µï¼š</strong> ${lastDate.getDay() === 5 ? 'ä»Šæ—¥é€±äº”(æ©Ÿå°B)' : 'ä¸€èˆ¬æ—¥'}</div>
            <hr border="0" style="border-top:1px solid #eee">
            <div style="font-size:0.8rem; color:#666;">* æ©Ÿå°å½±éŸ¿èˆ‡é–‹çå“¡è®Šæ•¸éœ€æ›´å¤šå¤–éƒ¨æ•¸æ“šå°å…¥æ–¹å¯è¨ˆç®—ã€‚</div>
        `;
    }

    function getFreq(data) {
        const f = {};
        data.forEach(r => r.nums.forEach(n => f[n] = (f[n] || 0) + 1));
        return f;
    }
</script>

</body>
</html>
