<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 回測系統｜熱號釋放版</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button { padding: 8px 16px; margin: 10px 0; }
.result { margin-top: 20px; line-height: 1.8; }
.highlight { font-size: 18px; font-weight: bold; }
table { border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #999; padding: 6px 10px; }
th { background: #eee; }
</style>
</head>
<body>

<h2>539 模擬系統（熱號釋放點版）</h2>

<input type="file" id="csvFile" accept=".csv">
<br>
<button onclick="runBacktest()">執行回測</button>

<div id="output" class="result"></div>
<div id="hitTable"></div>

<script>
function parseCSV(text) {
  return text.trim().split("\n").slice(1).map(r => {
    const p = r.split(",");
    return { date: p[0], nums: p.slice(1).map(Number) };
  });
}

function runBacktest() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("請上傳 CSV");

  const reader = new FileReader();
  reader.onload = () => {
    const draws = parseCSV(reader.result);

    let total = 0, played = 0;
    let hit2 = 0, hit3 = 0, hit4 = 0;
    let hitPeriods = 0;
    const hitRecords = [];

    for (let i = 30; i < draws.length; i++) {
      total++;
      const history = draws.slice(0, i);
      const actual = draws[i];

      // ===== Gap（極冷 ≥20）=====
      const gap = {};
      for (let n = 1; n <= 39; n++) gap[n] = 0;
      history.forEach(d => {
        for (let n = 1; n <= 39; n++) gap[n]++;
        d.nums.forEach(n => gap[n] = 0);
      });
      const cold = Object.keys(gap).filter(n => gap[n] >= 20).map(Number);
      if (cold.length === 0) continue;

      // ===== 熱號（近5期 ≥3次）=====
      const freq = {};
      history.slice(-5).forEach(d =>
        d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1)
      );
      const hot = Object.keys(freq).filter(n => freq[n] >= 3).map(Number);
      if (hot.length === 0) continue;

      // ===== 熱號釋放點 =====
      const last3 = history.slice(-3).flatMap(d => d.nums);
      const last1 = history[history.length - 1].nums;
      const releaseHot = hot.filter(
        n => last3.includes(n) && !last1.includes(n)
      );
      if (releaseHot.length === 0) continue;

      // === 出手 ===
      played++;

      // ===== 產生預測組 =====
      const preds = [];
      for (let a = 0; a < releaseHot.length && preds.length < 12; a++)
        for (let b = 0; b < hot.length && preds.length < 12; b++)
          for (let c = b + 1; c < hot.length && preds.length < 12; c++)
            for (let d = 0; d < cold.length && preds.length < 12; d++) {
              const p = [
                releaseHot[a],
                hot[b],
                hot[c],
                cold[d],
                cold[(d + 1) % cold.length]
              ];
              if (new Set(p).size === 5) preds.push(p);
            }

      let maxHit = 0;
      preds.forEach(p => {
        const h = p.filter(n => actual.nums.includes(n)).length;
        if (h > maxHit) maxHit = h;
      });

      if (maxHit >= 2) {
        hit2++;
        hitPeriods++;
        hitRecords.push({
          date: actual.date,
          nums: actual.nums.join(", "),
          hit: maxHit
        });
      }
      if (maxHit >= 3) hit3++;
      if (maxHit >= 4) hit4++;
    }

    document.getElementById("output").innerHTML = `
      <b>可回測期數：</b>${total}<br>
      <b>出手期數：</b>${played}<br>
      <span class="highlight">出手比例：${(played / total * 100).toFixed(1)}%</span>
      <hr>
      <b>命中期數（≥2）：</b>${hitPeriods}<br>
      出手期 ≥2：${played ? (hit2 / played * 100).toFixed(1) : 0}%<br>
      出手期 ≥3：${played ? (hit3 / played * 100).toFixed(1) : 0}%<br>
      <span class="highlight">出手期 ≥4：${played ? (hit4 / played * 100).toFixed(1) : 0}%</span>
    `;

    let html = `<h3>命中期明細（≥2）</h3>
      <table>
      <tr><th>日期</th><th>開獎號碼</th><th>最高命中</th></tr>`;
    hitRecords.forEach(r => {
      html += `<tr><td>${r.date}</td><td>${r.nums}</td><td>中 ${r.hit}</td></tr>`;
    });
    html += "</table>";

    document.getElementById("hitTable").innerHTML = html;
  };

  reader.readAsText(file);
}
</script>

</body>
</html>
