<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 策略回測與智能選牌系統</title>
    <style>
        :root {
            --primary-color: #1a3a5f;
            --accent-color: #3e95cd;
            --success-color: #28a745;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
        }

        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            padding: 20px; 
            background: var(--bg-color); 
            color: #333;
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* 檔案上傳區 */
        .upload-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        input[type="file"] { margin: 10px 0; }

        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        button:hover { background: #2d7da1; transform: translateY(-2px); }

        /* 卡片佈局 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #f8f9fa; color: var(--primary-color); }

        /* 號碼球樣式 */
        .ball {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            background: #e9ecef;
            margin: 2px;
            font-weight: bold;
            font-size: 14px;
        }

        .high-rate .ball {
            background: var(--success-color);
            color: white;
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.4);
        }

        .strategy-block {
            border-left: 5px solid var(--accent-color);
            padding-left: 15px;
            margin: 20px 0;
            background: #fcfcfc;
        }

        .rate-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            background: #eee;
            margin-left: 5px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 20px;
        }

        .pick-btn {
            background: #f1f3f5;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <header>
        <h1>539 策略分析與智能回測系統</h1>
        <p>基於歷史數據的機率評估模型</p>
    </header>

    <div class="upload-section">
        <label><strong>Step 1: 匯入歷史數據 (CSV)</strong></label><br>
        <input type="file" id="csvFile" accept=".csv"><br>
        <button onclick="runAll()">執行系統回測 ➔</button>
    </div>

    <div class="dashboard-grid">
        <div id="history" class="card"><h3>最近 5 期歷史</h3><p style="color:gray">等待數據載入...</p></div>
        <div id="stats_table" class="card"><h3>策略歷史表現</h3><p style="color:gray">等待數據載入...</p></div>
    </div>

    <div id="results" class="card">
        <h3>智能建議組合</h3>
        <p style="color:gray">請先執行回測以產生基於勝率排序的組合...</p>
    </div>

    <div class="chart-container">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<script>
const RULES = [
  { name: "A_保守型", pool: "last1+5", odd: [2,3], sum: [85,115], desc:"邏輯：追蹤上期熱碼並進行位移補捉。" },
  { name: "B_均衡型", pool: "last5+5+10", odd: [1,2,3,4], sum: [80,120], desc:"邏輯：擴大樣本至最近5期，平衡冷熱號碼。" },
  { name: "C_進取型", pool: "last5+10", odd: [3], sum: [90,125], desc:"邏輯：針對大幅跳號設計的積極型擴展策略。" }
];

async function runAll() {
    const fileInput = document.getElementById("csvFile");
    if (!fileInput.files[0]) { alert("請先載入 CSV 檔"); return; }

    const text = await fileInput.files[0].text();
    const data = parseCSV(text);

    showHistory(data);
    const stats = doBacktest(data);
    renderStatsTable(stats);
    drawTrendChart(stats.map(s=>s.hit2Rate*100), stats.map(s=>s.hit3Rate*100));

    // 生成建議區塊
    let resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "<h3>智能建議組合 (依回測期望值排序)</h3>";
    
    stats.forEach(s => {
        let picksWithRate = [];
        for(let i=0;i<3;i++){
            const pick = generateNextPick(data.slice(-5), s.rule);
            const hit2 = estimateHitRate(pick, data, 2);
            const hit3 = estimateHitRate(pick, data, 3);
            const hit4 = estimateHitRate(pick, data, 4);
            const hit5 = estimateHitRate(pick, data, 5);
            picksWithRate.push({pick, hit2, hit3, hit4, hit5});
        }
        picksWithRate.sort((a,b)=> ((b.hit2+b.hit3)/2)-((a.hit2+a.hit3)/2));

        let sBlock = document.createElement("div");
        sBlock.className = "strategy-block";
        sBlock.innerHTML = `<h4>策略：${s.rule.name} <small style="color:gray; font-weight:normal;">${s.rule.desc}</small></h4>`;
        
        picksWithRate.forEach((p,i)=>{
            const avgRate = (p.hit2+p.hit3)/2;
            const isHigh = avgRate >= 0.6;
            let ballsHtml = p.pick.map(n => `<span class="ball">${String(n).padStart(2,'0')}</span>`).join("");
            
            sBlock.innerHTML += `
                <div style="margin-bottom:15px;" class="${isHigh ? 'high-rate' : ''}">
                    <span class="pick-btn">組合 ${i+1}</span>
                    ${ballsHtml}
                    <span class="rate-badge">歷史中2+: ${(p.hit2*100).toFixed(1)}%</span>
                    <span class="rate-badge">歷史中3+: ${(p.hit3*100).toFixed(1)}%</span>
                    ${isHigh ? '<b style="color:#28a745; margin-left:10px;">★ 高期望值</b>' : ''}
                </div>`;
        });
        resultsDiv.appendChild(sBlock);
    });
}

function parseCSV(text){
    const lines = text.trim().split("\n");
    lines.shift();
    return lines.map(l=>{
        const p=l.split(",");
        return {date:p[0], nums:p.slice(2,7).map(n=>parseInt(n))};
    }).sort((a,b)=>new Date(a.date)-new Date(b.date));
}

function showHistory(data){
    let html = "<h3>最近 5 期開獎</h3><table><tr><th>日期</th><th>號碼</th></tr>";
    data.slice(-5).reverse().forEach(d=>{
        html += `<tr><td>${d.date}</td><td>${d.nums.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</td></tr>`;
    });
    html += "</table>";
    document.getElementById("history").innerHTML = html;
}

function doBacktest(data){
    const stats = RULES.map(r=>({rule:r, hit5:0, hit4:0, hit3:0, hit2:0, total:0}));
    for(let i=5;i<data.length;i++){
        const prev=data.slice(i-5,i), actual=data[i].nums;
        stats.forEach(s=>{
            const pick=generatePick(prev,s.rule);
            const hit = countHit(actual,pick);
            s.total++;
            if(hit>=2) s.hit2++; if(hit>=3) s.hit3++; if(hit>=4) s.hit4++; if(hit==5) s.hit5++;
        });
    }
    stats.forEach(s=>{
        s.hit2Rate = s.hit2/s.total; s.hit3Rate = s.hit3/s.total;
        s.hit4Rate = s.hit4/s.total; s.hit5Rate = s.hit5/s.total;
    });
    return stats;
}

function renderStatsTable(stats){
    let html = "<h3>策略歷史表現</h3><table><tr><th>策略</th><th>中3率</th><th>中2率</th><th>測試期數</th></tr>";
    stats.forEach(s=>{
        html += `<tr>
            <td><strong>${s.rule.name}</strong></td>
            <td>${(s.hit3Rate*100).toFixed(2)}%</td>
            <td>${(s.hit2Rate*100).toFixed(2)}%</td>
            <td>${s.total}</td>
        </tr>`;
    });
    html += "</table>";
    document.getElementById("stats_table").innerHTML = html;
}

function drawTrendChart(hit2Data, hit3Data){
    const ctx = document.getElementById("trendChart").getContext("2d");
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx,{
        type:'bar',
        data:{
            labels: RULES.map(r=>r.name),
            datasets:[
                { label:'歷史 ≥2 碼命中率 (%)', data: hit2Data, backgroundColor:'#3e95cd' },
                { label:'歷史 ≥3 碼命中率 (%)', data: hit3Data, backgroundColor:'#1a3a5f' }
            ]
        },
        options:{ 
            responsive: true,
            scales:{ y:{ beginAtZero:true, max:100 } },
            plugins: { title: { display: true, text: '策略勝率對比圖' } }
        }
    });
}

// 核心運算工具
function countHit(actual,pick){ return actual.filter(n=>pick.includes(n)).length; }
function estimateHitRate(pick,data,minHit){
    let count=0; data.forEach(d=>{ if(countHit(d.nums,pick)>=minHit) count++; });
    return count/data.length;
}
function buildPool(latest5,rule){
    const pool = new Set();
    if(rule.pool.includes("last1")) latest5[4].nums.forEach(n=>pool.add(n));
    if(rule.pool.includes("last5")) latest5.forEach(d=>d.nums.forEach(n=>pool.add(n)));
    [...pool].forEach(n=>{
        if(rule.pool.includes("+5") && n+5<=39) pool.add(n+5);
        if(rule.pool.includes("+10") && n+10<=39) pool.add(n+10);
    });
    return [...pool];
}
function generatePick(prev,rule){ const pool=buildPool(prev,rule); return shuffle(pool).slice(0,5).sort((a,b)=>a-b); }
function generateNextPick(latest5, rule){ const pool = buildPool(latest5, rule); return shuffle(pool).slice(0,5).sort((a,b)=>a-b); }
function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }
</script>

</body>
</html>
