<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 專業數據選牌器</title>
    <style>
        :root { --hot: #ff4757; --cold: #2f3542; --primary: #1e90ff; }
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        .stats { display: flex; justify-content: space-around; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        .ball { height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
                border-radius: 50%; border: 1px solid #ddd; cursor: pointer; position: relative; font-size: 14px; }
        .ball.selected { background: var(--hot); color: white; border-color: var(--hot); }
        .freq-tag { font-size: 9px; color: #777; margin-top: -2px; }
        .selected .freq-tag { color: white; }
        .actions { display: flex; gap: 8px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-sec { background: #e0e0e0; }
        .result { text-align: center; font-size: 28px; margin-top: 20px; color: var(--hot); letter-spacing: 2px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; margin-top:0;">539 數據選牌助手</h2>
    
    <div style="border: 2px dashed #ccc; padding: 10px; text-align: center;">
        <small>請上傳 history_last30.csv</small><br>
        <input type="file" id="csvFile" accept=".csv" onchange="process()">
    </div>

    <div class="stats">
        <span>平均值: <span id="avg">0</span></span>
        <span>最熱門: <span id="top-num">-</span></span>
    </div>

    <div class="grid" id="grid"></div>

    <div class="actions">
        <button class="btn-main" onclick="smartPick()">智慧隨機 (依權重)</button>
        <button class="btn-sec" onclick="reset()">重置</button>
    </div>

    <div class="result" id="res">00 00 00 00 00</div>
</div>

<script>
    let freq = {};
    let selected = new Set();

    function process() {
        const file = document.getElementById('csvFile').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n');
            freq = {};
            // 跳過第一行標題，解析數據
            for(let i=1; i<lines.length; i++) {
                const cols = lines[i].split(',');
                if(cols.length < 6) continue;
                for(let j=1; j<=5; j++) {
                    const n = parseInt(cols[j]);
                    if(n) freq[n] = (freq[n] || 0) + 1;
                }
            }
            render();
            updateStats();
        };
        reader.readAsText(file);
    }

    function render() {
        const g = document.getElementById('grid');
        g.innerHTML = '';
        for(let i=1; i<=39; i++) {
            const b = document.createElement('div');
            b.className = `ball ${selected.has(i) ? 'selected' : ''}`;
            b.innerHTML = `<div>${i.toString().padStart(2,'0')}</div><div class="freq-tag">${freq[i] || 0}次</div>`;
            b.onclick = () => {
                if(selected.has(i)) selected.delete(i);
                else if(selected.size < 5) selected.add(i);
                render();
                updateStats();
            };
            g.appendChild(b);
        }
    }

    function smartPick() {
        selected.clear();
        let pool = [];
        for(let i=1; i<=39; i++) {
            // 基本權重 1 + 歷史出現次數
            let weight = 1 + (freq[i] || 0);
            for(let w=0; w<weight; w++) pool.push(i);
        }
        while(selected.size < 5) {
            selected.add(pool[Math.floor(Math.random() * pool.length)]);
        }
        render();
        updateStats();
    }

    function updateStats() {
        const arr = Array.from(selected).sort((a,b)=>a-b);
        document.getElementById('res').innerText = arr.length ? arr.map(n=>n.toString().padStart(2,'0')).join(' ') : '00 00 00 00 00';
        
        if(Object.keys(freq).length > 0) {
            const top = Object.keys(freq).reduce((a, b) => freq[a] > freq[b] ? a : b);
            document.getElementById('top-num').innerText = top;
        }
        
        const sum = arr.reduce((a,b)=>a+b, 0);
        document.getElementById('avg').innerText = arr.length ? (sum/arr.length).toFixed(1) : 0;
    }

    function reset() {
        selected.clear();
        render();
        updateStats();
    }

    render();
</script>
</body>
</html>
